<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL QUIZ v6.5.1 (CORE UPDATE)</title>
    <style>
        :root {
            --color-bg-primary: #0A0A0A; --color-surface: #141414; --color-func: #2A2A2A; --color-text-passive: #B0B0B0; --color-text-bright: #FFFFFF; --color-accent-primary: #00FFFF; --color-accent-bios: #00FF8A; --color-error: #FF414B; --color-success: #39FF14; --color-accent-gold: #FFD700; --color-warning: #FFD300;
            --gap-s: clamp(4px, 1vmin, 8px);
            --gap-m: clamp(8px, 2vmin, 16px);
            --gap-l: clamp(16px, 4vmin, 32px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; font-size: clamp(10px, 2.5vmin, 22px); }
        body { width: 100%; height: 100%; overflow: hidden; background-color: var(--color-bg-primary); color: var(--color-text-bright); font-family: Consolas, Menlo, Courier New, monospace; font-size: 1rem; position: relative; }
        #perspective-container { perspective: 1200px; width: 100%; height: 100%; position: relative; }
        body::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.5) 0px, rgba(0,0,0,0.4) 1px, transparent 2px, transparent 3px); z-index: 10; animation: scanline-scroll 20s linear infinite; }
        @keyframes scanline-scroll { to { background-position-y: 100%; } }
        body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background-image: linear-gradient(var(--color-surface) 1px, transparent 1px), linear-gradient(90deg, var(--color-surface) 1px, transparent 1px); background-size: 40px 40px; opacity: 0.05; z-index: -1; }
        main { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-style: preserve-3d; }
        
        .window { width: 100%; height: 100%; padding: 0 var(--gap-l); position: absolute; top: 0; left: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; opacity: 0; transform: translateX(-100px) translateZ(-200px); pointer-events: none; visibility: hidden; transition: opacity 400ms cubic-bezier(0.4, 0, 0.2, 1), transform 400ms cubic-bezier(0.4, 0, 0.2, 1), visibility 400ms; }
        .window.active { opacity: 1; transform: translateX(0) translateZ(0px); pointer-events: auto; visibility: visible; }
        
        .window-content { flex-grow: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--gap-m) 0; min-height: 0; }
        #preload, #title, #victory, #gameOver { justify-content: center; padding: var(--gap-m) var(--gap-l); }
        h1 { font-size: clamp(2rem, 10vmin, 5rem); color: var(--color-accent-primary); letter-spacing: clamp(4px, 1vmin, 8px); text-shadow: 0 0 5px var(--color-accent-primary), 0 0 15px var(--color-accent-primary), 0 0 25px var(--color-accent-primary); max-width: 100%; word-break: break-word; }
        h2 { font-size: clamp(1.5rem, 6vmin, 3rem); color: var(--color-text-bright); margin-bottom: var(--gap-m); display: flex; align-items: center; justify-content: center; }
        p { font-size: clamp(0.8rem, 2.5vmin, 1.1rem); color: var(--color-text-passive); max-width: 90%; line-height: 1.6; }
        
        .interactive-button, button { 
            background: linear-gradient(135deg, var(--color-func) 0%, #1a1a1a 100%);
            border: 2px solid var(--color-surface); 
            color: var(--color-text-bright); 
            padding: var(--gap-s) var(--gap-m); 
            font-family: inherit; 
            font-size: clamp(0.9rem, 2.5vmin, 1.2rem); 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: all 280ms cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .interactive-button::before, button::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .interactive-button:hover, button:hover { 
            background: linear-gradient(135deg, var(--color-surface) 0%, #252525 100%);
            border-color: var(--color-accent-primary); 
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 255, 255, 0.4), 0 0 20px rgba(0, 255, 255, 0.2);
        }
        .interactive-button:hover::before, button:hover::before {
            width: 300px;
            height: 300px;
        }
        .interactive-button:active, button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .interactive-button:focus-visible, button:focus-visible { 
            outline: 3px solid var(--color-accent-bios); 
            outline-offset: 2px; 
        }
        .interactive-button:disabled, button:disabled { 
            background: var(--color-func); 
            border-color: #222; 
            color: #444; 
            cursor: not-allowed; 
            opacity: 0.4; 
            filter: grayscale(80%); 
            transform: scale(0.95); 
        }
        
        .telemetry-header { width: 100%; flex-shrink: 0; text-transform: uppercase; color: var(--color-text-passive); font-size: clamp(0.7rem, 2vmin, 0.9rem); letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; padding: var(--gap-s); border-bottom: 1px solid var(--color-surface); position: relative; }
        .telemetry-footer { padding: var(--gap-s); border-top: 1px solid var(--color-surface); }
        .telemetry-group { display: flex; align-items: center; gap: var(--gap-m); }
        .settings-button { background: none; border: none; font-size: clamp(1.2rem, 4vmin, 1.8rem); color: var(--color-text-passive); cursor: pointer; padding: 0 var(--gap-s); transition: color 220ms, transform 220ms; }
        .settings-button:hover { color: var(--color-accent-primary); transform: rotate(90deg); }
        .settings-menu { position: absolute; top: 100%; right: 0; background-color: var(--color-bg-primary); border: 1px solid var(--color-surface); z-index: 100; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transform: translateY(-10px); pointer-events: none; transition: opacity 220ms, visibility 220ms, transform 220ms; }
        .settings-menu.active { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
        .settings-menu button { width: 100%; text-align: left; background-color: var(--color-func); border: none; font-size: clamp(0.8rem, 2vmin, 1rem); border-top: 1px solid var(--color-surface); }
        .settings-menu button:first-child { border-top: none; }
        .settings-menu button:hover { background-color: var(--color-surface); }
        .palette-container { position: relative; }
        .palette-submenu { display: none; position: absolute; top: 0; right: 100%; background-color: var(--color-bg-primary); border: 1px solid var(--color-surface); }
        .palette-container.open .palette-submenu { display: block; }
        
        @keyframes particle-burst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        .celebration-particle {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--particle-color, var(--color-accent-bios));
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: particle-burst 1s ease-out forwards;
            box-shadow: 0 0 10px var(--particle-color, var(--color-accent-bios));
        }
        
        #glitch-wrapper.glitch-active { animation: glitch-error-effect 300ms ease-in-out; }
        @keyframes glitch-error-effect { 0%, 100% { transform: translate(0, 0); } 10% { transform: translate(-5px, -3px) skewX(-5deg); } 30% { transform: translate(3px, 5px) skewX(5deg); } 50% { transform: translate(-3px, -5px); } 70% { transform: translate(5px, 3px); } 90% { transform: translate(-3px, 3px) skewX(-2deg); } }
        #holographic-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--gap-m); transform-style: preserve-3d; transform: rotateX(10deg); transition: transform 0.1s linear; filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.4)); width: 100%; max-width: 100%; }
        #holographic-panel.error-flash { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)) blur(1px); }
        #profilesList { list-style: none; margin-bottom: var(--gap-m); display: flex; flex-direction: column; gap: var(--gap-s); max-height: 50vh; width: 100%; max-width: 450px; }
        .profile-entry { display: flex; gap: var(--gap-s); align-items: center; }
        .profile-button { flex-grow: 1; text-align: left; padding-left: 20px;}
        .delete-button { width: clamp(38px, 10vmin, 48px); height: clamp(38px, 10vmin, 48px); padding: 0; font-size: clamp(1rem, 4vmin, 1.5rem); flex-shrink: 0; background-color: var(--color-error); border-color: #8B0000; }
        #levelGrid { display: flex; flex-direction: column; gap: var(--gap-m); max-width: 550px; width: 100%; }
        #levelGrid button { 
            padding: var(--gap-m); 
            font-size: clamp(0.9rem, 3vmin, 1.2rem); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 70px;
        }
        #levelGrid button::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: lcars-scan 4s linear infinite;
        }
        @keyframes lcars-scan {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        .level-button-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            gap: var(--gap-m);
            z-index: 1;
            position: relative;
        }
        .level-info-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            gap: 4px;
        }
        .level-category {
            font-size: clamp(1rem, 3.5vmin, 1.4rem);
            font-weight: bold;
            letter-spacing: 2px;
            color: var(--color-text-bright);
        }
        .level-starfleet-name {
            font-size: clamp(0.7rem, 2vmin, 0.9rem);
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }
        .level-title { flex-grow: 1; text-align: left; }
        .progress-cubes-container { display: flex; gap: 4px; }
        .progress-cube { 
            width: clamp(8px, 2vmin, 12px); 
            height: clamp(8px, 2vmin, 12px); 
            border: 1px solid var(--color-surface); 
            background-color: transparent;
            transition: all 0.3s ease;
        }
        .progress-cube.filled { 
            background: radial-gradient(circle, var(--color-accent-bios) 0%, rgba(34,139,34,0.7) 100%);
            box-shadow: 0 0 6px var(--color-accent-bios);
            animation: pulse-cube 2s ease-in-out infinite;
        }
        @keyframes pulse-cube {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #profileStatsContainer {
            display: flex;
            gap: var(--gap-l);
            background-color: rgba(10, 10, 10, 0.5);
            border: 1px solid var(--color-surface);
            padding: var(--gap-m);
            margin-bottom: var(--gap-l);
            border-radius: 4px;
            font-size: clamp(0.8rem, 2.5vmin, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-label {
            font-size: 0.8em;
            color: var(--color-text-passive);
        }
        .stat-value {
            font-weight: bold;
        }
        #statValueAciertos { color: var(--color-success); }
        #statValueErrores { color: var(--color-error); }
        #statValuePrecision { color: var(--color-accent-gold); }

        #playerNameDisplay { 
            position: relative;
            width: min(90vw, calc(var(--k) * 8 + var(--gap-s) * 7)); 
            height: calc(var(--k) * 1.4); 
            background: linear-gradient(135deg, var(--color-surface) 0%, #1a1a1a 100%);
            border: 3px solid var(--color-func); 
            color: var(--color-accent-primary); 
            font-size: calc(var(--k) * 0.65); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            letter-spacing: 4px; 
            margin-bottom: var(--gap-l);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 0 20px rgba(0, 255, 255, 0.2);
            border-radius: 4px;
        }
        #playerNameDisplay .cursor {
            position: absolute;
            left: calc(50% + (var(--chars, 0) / 2 * 1ch) + 2px);
            width: 0.6ch;
            height: 70%;
            background-color: var(--color-accent-primary);
            animation: blink 1s steps(2, start) infinite;
            box-shadow: 0 0 8px var(--color-accent-primary);
        }
        @keyframes blink { to { visibility: hidden; } }
        #playerNameDisplay.shake { animation: shake-horizontal 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-horizontal { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #playerNameDisplay.error-flash { animation: flash-error 0.5s ease-out; }
        @keyframes flash-error { 0%, 100% { border-color: var(--color-func); } 50% { border-color: var(--color-error); box-shadow: 0 0 30px rgba(255, 65, 75, 0.6); } }
        
        #virtualKeyboard { 
            display: grid; 
            grid-template-columns: repeat(8, var(--k)); 
            grid-auto-rows: var(--k); 
            gap: var(--gap-m);
            max-width: 90vw;
        }
        #virtualKeyboard .key { 
            padding: 0; 
            font-size: calc(var(--k) * 0.55); 
            text-transform: none;
            font-weight: bold;
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #2e2e2e 0%, #1a1a1a 100%);
            border: 2px solid #3a3a3a;
            position: relative;
        }
        #virtualKeyboard .key:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.3);
            border-color: var(--color-accent-primary);
        }
        #virtualKeyboard .key:active {
            transform: translateY(1px) scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.4);
        }
        .key[data-key="Enter"] { 
            background: linear-gradient(145deg, var(--color-accent-bios) 0%, #00a060 100%);
            border-color: #006400;
            box-shadow: 0 4px 12px rgba(0, 255, 138, 0.3);
        }
        .key[data-key="Enter"]:hover {
            box-shadow: 0 6px 20px rgba(0, 255, 138, 0.5);
        }
        .key[data-key="Shift"] { 
            background: linear-gradient(145deg, #3a3a3a 0%, #1e1e1e 100%);
        }
        .key[data-key="Shift"].shift-active {
            background: linear-gradient(145deg, var(--color-accent-primary) 0%, #00a0a0 100%);
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            color: #000;
        }
        .key[data-key="Backspace"] {
            background: linear-gradient(145deg, #4a4a4a 0%, #2a2a2a 100%);
        }
        
        #quizQuestion { font-size: clamp(1.2rem, 4vmin, 2rem); color: var(--color-accent-gold); margin-bottom: var(--gap-l); max-width: 900px; line-height: 1.5; }

        #quizOptions { display: grid; grid-template-columns: 1fr; gap: var(--gap-m); width: 100%; max-width: 800px; }
        @media (min-width: 600px) { #quizOptions { grid-template-columns: 1fr 1fr; } }
        
        .option-button { 
            padding: clamp(12px, 3vmin, 24px) var(--gap-m); 
            text-transform: none; 
            font-size: clamp(1.2rem, 4.5vmin, 2rem);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .option-button.correct-answer { 
            background: linear-gradient(135deg, var(--color-success) 0%, #1a8a0d 100%);
            border-color: #0d5a00; 
            color: var(--color-bg-primary);
            animation: pulse-success 0.6s ease-out;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.6);
        }
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .option-button.incorrect-answer { 
            background: linear-gradient(135deg, var(--color-error) 0%, #8B0000 100%);
            border-color: #660000;
            animation: shake-wrong 0.5s ease-out;
        }
        @keyframes shake-wrong {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .ascii-art-container { width: clamp(90px, 20vmin, 120px); height: clamp(90px, 20vmin, 120px); margin-bottom: var(--gap-m); }
        .centered-hud-item { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        #gameHudPlayerName { color: var(--color-text-passive); }
        #gameHudStreak { 
            color: var(--color-accent-gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        #timeBarContainer { 
            width: 120px; 
            height: 14px; 
            border: 2px solid var(--color-surface); 
            background-color: #000; 
            padding: 2px;
            border-radius: 8px;
            overflow: hidden;
        }
        #timeBarFill { 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(90deg, var(--color-accent-bios) 0%, #00a060 100%);
            transition: width 0.2s linear, background 0.5s ease;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 255, 138, 0.5);
        }
        #timeBarFill.warning { 
            background: linear-gradient(90deg, var(--color-warning) 0%, #cc9900 100%);
            animation: pulse-warning 1s ease-in-out infinite;
        }
        #timeBarFill.critical { 
            background: linear-gradient(90deg, var(--color-error) 0%, #cc0000 100%);
            animation: pulse-critical 0.5s ease-in-out infinite;
        }
        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 211, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 211, 0, 0.8); }
        }
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 65, 75, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 65, 75, 1); }
        }
        
        #rankInsigniaDisplay { display: inline-block; width: 30px; height: 45px; vertical-align: middle; margin-left: var(--gap-m); }
        #rankInsigniaDisplay svg { width: 100%; height: 100%; }
        .mastery-insignia { width: 24px; height: 36px; flex-shrink: 0; }
        .mastery-insignia svg { width: 100%; height: 100%; }
        
        #insigniasContainer {
            display: flex;
            flex-direction: row;
            gap: var(--gap-l);
            width: 100%;
            max-width: 1100px;
            height: 70vh;
        }

        #insigniasList {
            flex: 2;
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--gap-m); 
            padding: var(--gap-m);
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.5) 0%, rgba(10, 10, 10, 0.5) 100%);
            border-radius: 15px;
            border: 2px solid var(--color-surface);
        }

        #insigniaGlyphDisplay {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, #1a1a1a 0%, #0A0A0A 100%);
            border: 2px solid var(--color-accent-primary);
            border-radius: 15px;
            padding: var(--gap-l);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            text-align: center;
        }

        #insigniaGlyphDisplay .glyph-svg-container {
            width: 80%;
            max-width: 200px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #insigniaGlyphDisplay .glyph-svg-container svg {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 20px var(--color-accent-gold));
        }
        #insigniaGlyphDisplay .glyph-title {
            font-size: clamp(1rem, 3vmin, 1.3rem);
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: var(--gap-m);
            flex-shrink: 0;
            height: 60px;
        }
        
        .insignia-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            gap: var(--gap-s); 
            text-align: center;
            padding: var(--gap-m);
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.8) 0%, rgba(20, 20, 20, 0.8) 100%);
            border: 2px solid #555;
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .insignia-item:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent-primary);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
        }
        .insignia-item-svg { 
            width: 50px; 
            height: 75px;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
        }
        .insignia-item-title { 
            font-size: clamp(0.8rem, 2vmin, 1rem); 
            color: var(--color-text-bright); 
            font-weight: bold;
            line-height: 1.2;
        }
        
        .victory-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--gap-l); width: 100%; position: relative; }
        
        .teleport-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 400px; pointer-events: none; z-index: 1; }
        .teleport-effect::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 255, 0.1) 20%, rgba(0, 255, 255, 0.2) 40%, rgba(0, 255, 255, 0.3) 50%, rgba(0, 255, 255, 0.2) 60%, rgba(0, 255, 255, 0.1) 80%, transparent 100%); animation: teleport-shimmer 2s ease-in-out infinite; }
        @keyframes teleport-shimmer { 0%, 100% { opacity: 0; transform: translateY(-100%); } 50% { opacity: 1; transform: translateY(100%); } }
        
        .insignia-showcase { width: 150px; height: 200px; perspective: 1000px; position: relative; z-index: 2; margin: var(--gap-l) 0; }
        .insignia-3d-display { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: float-rotate 4s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.6)); }
        .insignia-3d-display svg { width: 100%; height: 100%; }
        @keyframes float-rotate { 0%, 100% { transform: rotateY(0deg) translateY(0px); } 25% { transform: rotateY(90deg) translateY(-10px); } 50% { transform: rotateY(180deg) translateY(0px); } 75% { transform: rotateY(270deg) translateY(-10px); } }
        
        .insignia-showcase::after { content: ""; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 50%; transform: translate(-50%, -50%); animation: orbit-pulse 3s ease-in-out infinite; }
        @keyframes orbit-pulse { 0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; } }
        
        .lcars-info-panel { display: flex; align-items: center; gap: var(--gap-m); padding: var(--gap-m); background: linear-gradient(90deg, rgba(255, 153, 102, 0.1) 0%, rgba(153, 153, 255, 0.1) 100%); border-radius: 20px; border: 2px solid rgba(0, 255, 255, 0.3); position: relative; overflow: hidden; max-width: 600px; }
        .lcars-info-panel::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent); animation: lcars-scan-victory 3s linear infinite; }
        @keyframes lcars-scan-victory { 0% { left: -100%; } 100% { left: 200%; } }
        .lcars-bar { width: 40px; height: 60px; border-radius: 20px; flex-shrink: 0; }
        .lcars-bar.left-bar { background: linear-gradient(180deg, #FF9966 0%, #CC6633 100%); }
        .lcars-bar.right-bar { background: linear-gradient(180deg, #9999FF 0%, #6666CC 100%); }
        .victory-message { font-size: clamp(1rem, 3vmin, 1.3rem); color: var(--color-text-bright); letter-spacing: 2px; z-index: 1; }
        .victory-title { animation: glow-pulse 2s ease-in-out infinite; }
        @keyframes glow-pulse { 0%, 100% { text-shadow: 0 0 10px var(--color-success), 0 0 20px var(--color-success); } 50% { text-shadow: 0 0 20px var(--color-success), 0 0 40px var(--color-success), 0 0 60px var(--color-success); } }
        
        .starfleet-button { background: linear-gradient(135deg, var(--color-accent-primary) 0%, #008B8B 100%); border: 3px solid var(--color-accent-primary); color: #000; font-weight: bold; padding: var(--gap-m) var(--gap-l); font-size: clamp(1rem, 3vmin, 1.3rem); text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; }
        .starfleet-button::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%); transform: rotate(45deg); animation: starfleet-shine 3s linear infinite; }
        @keyframes starfleet-shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        .starfleet-button:hover { background: linear-gradient(135deg, #00FFFF 0%, #00CED1 100%); box-shadow: 0 0 30px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.5); transform: translateY(-3px) scale(1.05); }

        #glitchOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg-primary); z-index: 9999; pointer-events: none; opacity: 0; }
        #glitchOverlay.active { opacity: 1; animation: glitch-transition 300ms steps(2, end); }
        @keyframes glitch-transition {
            0% { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); transform: translate(-10px, 0); }
            10% { clip-path: polygon(0 75%, 100% 75%, 100% 75%, 0 75%); transform: translate(5px, 0); }
            20% { clip-path: polygon(0 50%, 100% 50%, 100% 20%, 0 20%); transform: translate(-7px, 0); }
            30% { clip-path: polygon(0 90%, 100% 90%, 100% 90%, 0 90%); transform: translate(10px, 0); }
            40% { clip-path: polygon(0 40%, 100% 40%, 100% 80%, 0 80%); transform: translate(-5px, 0); }
            50% { clip-path: polygon(0 60%, 100% 60%, 100% 60%, 0 60%); transform: translate(3px, 0); }
            60% { clip-path: polygon(0 15%, 100% 15%, 100% 35%, 0 35%); transform: translate(-8px, 0); }
            70% { clip-path: polygon(0 85%, 100% 85%, 100% 85%, 0 85%); transform: translate(4px, 0); }
            80% { clip-path: polygon(0 55%, 100% 55%, 100% 45%, 0 45%); transform: translate(-6px, 0); }
            90% { clip-path: polygon(0 25%, 100% 25%, 100% 30%, 0 30%); transform: translate(8px, 0); }
            100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); transform: translate(0, 0); }
        }

    </style>
</head>
<body>
    <div id="perspective-container">
        <main id="appContainer">
            <div id="preload" class="window active"><H1>CARGANDO...</H1></div>
            <div id="title" class="window"><h1>TERMINAL QUIZ</h1><p>PRESIONA CUALQUIER TECLA PARA CONTINUAR</p></div>
            
            <div id="profiles" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: SELECT PROFILE</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button" data-menu-id="settingsMenuProfiles">&#9881;</button><div id="settingsMenuProfiles" class="settings-menu"><button class="sound-toggle-button">SONIDO: ON</button><button class="insignias-button">INSIGNIAS</button><div class="palette-container"><button class="palette-toggle-button">PALETA</button><div class="palette-submenu"></div></div><button class="close-session-button">CERRAR SESIÓN</button></div></div></header>
                <div class="window-content"><h2>PERFILES DE USUARIO</h2><ul id="profilesList"></ul><button id="goToPlayerCreateButton" class="interactive-button">CREAR NUEVO PERFIL</button></div>
                <footer class="telemetry-footer">BUILD: v6.5.1-core</footer>
            </div>

            <div id="player" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: CREATE PROFILE</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button" data-menu-id="settingsMenuPlayer">&#9881;</button><div id="settingsMenuPlayer" class="settings-menu"><button class="sound-toggle-button">SONIDO: ON</button><button class="insignias-button">INSIGNIAS</button><div class="palette-container"><button class="palette-toggle-button">PALETA</button><div class="palette-submenu"></div></div><button class="close-session-button">CERRAR SESIÓN</button></div></div></header>
                <div class="window-content"><h2>NUEVO JUGADOR</h2><div id="playerNameDisplay"><span id="playerNameText"></span><span class="cursor"></span></div><div id="virtualKeyboard"></div><div style="display: flex; gap: 16px; margin-top: 16px;"><button id="cancelPlayerButton">CANCELAR</button></div></div>
                <footer class="telemetry-footer">BUILD: v6.5.1-core</footer>
            </div>
            
            <div id="mainMenu" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: MAIN MENU</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button" data-menu-id="settingsMenuMain">&#9881;</button><div id="settingsMenuMain" class="settings-menu"><button class="sound-toggle-button">SONIDO: ON</button><button class="insignias-button">INSIGNIAS</button><div class="palette-container"><button class="palette-toggle-button">PALETA</button><div class="palette-submenu"></div></div><button class="close-session-button">CERRAR SESIÓN</button></div></div></header>
                <div class="window-content">
                    <h2 id="mainMenuHeader">JUGADOR: <span id="profileDisplayName"></span><span id="rankInsigniaDisplay"></span></h2>
                    <div id="profileStatsContainer">
                        <div class="stat-item">
                            <span class="stat-label">Aciertos</span>
                            <span class="stat-value" id="statValueAciertos">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Errores</span>
                            <span class="stat-value" id="statValueErrores">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Precisión</span>
                            <span class="stat-value" id="statValuePrecision">0%</span>
                        </div>
                    </div>
                    <div id="levelGrid"></div><button id="backToProfilesButton" style="margin-top: 16px;">VOLVER A PERFILES</button>
                </div>
                <footer class="telemetry-footer">BUILD: v6.5.1-core</footer>
            </div>
            
            <div id="game" class="window">
                <header class="telemetry-header">
                    <span id="gameHudStreak">RACHA: 0</span>
                    <span id="gameHudPlayerName" class="centered-hud-item"></span>
                    <div class="telemetry-group">
                        <div id="timeBarContainer"><div id="timeBarFill"></div></div>
                        <button class="settings-button" data-menu-id="settingsMenuGame">&#9881;</button>
                        <div id="settingsMenuGame" class="settings-menu"><button class="sound-toggle-button">SONIDO: ON</button><button class="insignias-button">INSIGNIAS</button><div class="palette-container"><button class="palette-toggle-button">PALETA</button><div class="palette-submenu"></div></div><button class="close-session-button">CERRAR SESIÓN</button></div>
                    </div>
                </header>
                <div class="window-content"><div id="glitch-wrapper"><div id="holographic-panel"><h2>CALCULAR</h2><p id="quizQuestion"></p><div id="quizOptions"></div></div></div></div>
                <footer class="telemetry-footer">BUILD: v6.5.1-core</footer>
            </div>
            
            <div id="victory" class="window">
                <div class="victory-container">
                    <div class="teleport-effect" id="teleportEffect"></div>
                    <div class="insignia-showcase" id="insigniaShowcase">
                        <div class="insignia-3d-display" id="insignia3dDisplay"></div>
                    </div>
                    <h1 style="color: var(--color-success); text-shadow: 0 0 20px var(--color-success);">RESPUESTA CORRECTA</h1>
                    <h2 class="victory-title">VICTORIA</h2>
                    <div class="lcars-info-panel">
                        <div class="lcars-bar left-bar"></div>
                        <p class="victory-message">HAS RESUELTO LA OPERACIÓN.</p>
                        <div class="lcars-bar right-bar"></div>
                    </div>
                    <button id="victoryToMenuButton" class="starfleet-button">TRANSPORTAR AL MENÚ</button>
                </div>
            </div>
            <div id="gameOver" class="window"><div class="ascii-art-container"><div class="ascii-art ascii-art-defeat"></div></div><h1 style="color: var(--color-error);">RESPUESTA INCORRECTA</h1><h2>DERROTA</h2><p id="gameOverCorrectAnswer"></p><button id="gameOverToMenuButton">REINTENTAR DESDE EL MENÚ</button></div>
            
            <div id="insignias" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: VISUALIZADOR DE INSIGNIAS</span></header>
                <div class="window-content">
                    <h2 style="margin-bottom: var(--gap-l);">COLECCIÓN DE INSIGNIAS</h2>
                    <div id="insigniasContainer">
                        <div id="insigniasList"></div>
                        <div id="insigniaGlyphDisplay">
                            <div class="glyph-svg-container"></div>
                            <div class="glyph-title"></div>
                        </div>
                    </div>
                </div>
                <footer class="telemetry-footer"><button id="closeInsigniasButton">VOLVER</button></footer>
            </div>

            <div id="fullscreenOverlay" class="window" style="z-index: 999; background-color: rgba(0,0,0,0.95);"><h2>MODO PANTALLA COMPLETA REQUERIDO</h2><p>PARA UNA EXPERIENCIA ÓPTIMA, EL SISTEMA REQUIERE OPERAR EN MODO DE PANTALLA COMPLETA.</p><button id="reEnterFullscreenButton">REACTIVAR</button></div>
            
            <div id="glitchOverlay"></div>
        </main>
    </div>
    <script>
        (function() {
            'use strict';
            var QUESTION_TIME = 25;
            
            function createCelebrationParticles(x, y) {
                var colors = ['#39FF14', '#00FFFF', '#FFD700', '#00FF8A'];
                for (var i = 0; i < 20; i++) {
                    var particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    var color = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.setProperty('--particle-color', color);
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    var angle = (Math.PI * 2 * i) / 20;
                    var distance = 100 + Math.random() * 100;
                    var tx = Math.cos(angle) * distance;
                    var ty = Math.sin(angle) * distance;
                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');
                    document.body.appendChild(particle);
                    setTimeout(function(p) { return function() { if (p.parentNode) p.parentNode.removeChild(p); }; }(particle), 1000);
                }
            }
            
            function createEventBus() { var listeners = {}; return { on: function(eventName, callback) { if (!listeners[eventName]) { listeners[eventName] = []; } listeners[eventName].push(callback); }, off: function(eventName, callback) { if (!listeners[eventName]) return; listeners[eventName] = listeners[eventName].filter(function(cb) { return cb !== callback; }); }, emit: function(eventName, data) { if (!listeners[eventName]) return; listeners[eventName].forEach(function(callback) { callback(data); }); } }; }
            var EventBus = createEventBus();
            var AudioManager = { audioCtx: null, init: function() { if (!this.audioCtx && (window.AudioContext || window.webkitAudioContext)) { try { this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("[AUDIO] Web Audio API not supported.", e); } } }, playSound: function(type) { if (!state.settings.soundEnabled || !this.audioCtx) return; var osc = this.audioCtx.createOscillator(); var gain = this.audioCtx.createGain(); osc.connect(gain); gain.connect(this.audioCtx.destination); var now = this.audioCtx.currentTime; switch(type) { case 'tick': osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break; case 'success': osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break; case 'error': osc.type = 'square'; osc.frequency.setValueAtTime(164.81, now); osc.frequency.exponentialRampToValueAtTime(73.42, now + 0.2); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2); osc.start(now); osc.stop(now + 0.2); break; case 'navigate': osc.type = 'sine'; osc.frequency.setValueAtTime(330, now); osc.frequency.exponentialRampToValueAtTime(660, now + 0.15); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.15); osc.start(now); osc.stop(now + 0.15); break; } } };
            
            function getDefaultSettings() { return { soundEnabled: true, paletteIndex: 0 }; }
            function getEmptyProfileData() { return { solvedQuestions: { 'SUMAS': [], 'RESTAS': [], 'MULTIPLICACION': [], 'DIVISIONES': [] }, perfectRuns: { 'SUMAS': false, 'RESTAS': false, 'MULTIPLICACION': false, 'DIVISIONES': false }, aciertos: 0, errores: 0 }; }

            var state = { currentWindow: 'preload', previousWindow: null, activeProfile: null, profiles: {}, newPlayerName: '', isShiftActive: false, settings: getDefaultSettings(), quiz: { currentDifficulty: null, currentQuestion: null, isAnswered: false, prngState: 0, streak: 0, timerValue: QUESTION_TIME, timerId: null } };
            var windows = { preload: document.getElementById('preload'), title: document.getElementById('title'), profiles: document.getElementById('profiles'), player: document.getElementById('player'), mainMenu: document.getElementById('mainMenu'), game: document.getElementById('game'), victory: document.getElementById('victory'), gameOver: document.getElementById('gameOver'), insignias: document.getElementById('insignias'), fullscreenOverlay: document.getElementById('fullscreenOverlay') };
            var ui = { levelGrid: document.getElementById('levelGrid'), profilesList: document.getElementById('profilesList'), goToPlayerCreateButton: document.getElementById('goToPlayerCreateButton'), mainMenuHeader: document.getElementById('mainMenuHeader'), profileDisplayName: document.getElementById('profileDisplayName'), rankInsigniaDisplay: document.getElementById('rankInsigniaDisplay'), backToProfilesButton: document.getElementById('backToProfilesButton'), playerNameDisplay: document.getElementById('playerNameDisplay'), playerNameText: document.getElementById('playerNameText'), virtualKeyboard: document.getElementById('virtualKeyboard'), cancelPlayerButton: document.getElementById('cancelPlayerButton'), quizQuestion: document.getElementById('quizQuestion'), quizOptions: document.getElementById('quizOptions'), victoryToMenuButton: document.getElementById('victoryToMenuButton'), gameOverToMenuButton: document.getElementById('gameOverToMenuButton'), gameOverCorrectAnswer: document.getElementById('gameOverCorrectAnswer'), reEnterFullscreenButton: document.getElementById('reEnterFullscreenButton'), holographicPanel: document.getElementById('holographic-panel'), glitchWrapper: document.getElementById('glitch-wrapper'), gameHudPlayerName: document.getElementById('gameHudPlayerName'), gameHudStreak: document.getElementById('gameHudStreak'), timeBarFill: document.getElementById('timeBarFill'), insigniasList: document.getElementById('insigniasList'), closeInsigniasButton: document.getElementById('closeInsigniasButton'), glitchOverlay: document.getElementById('glitchOverlay') };
            var PLAYER_KEYBOARD_LAYOUT = [
                ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I'],
                ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K'],
                ['L', 'Ñ', 'Z', 'X', 'C', 'V', 'B', 'N'],
                [{ key: 'Shift', span: 2 }, 'M', 'O', 'P', { key: 'Enter', span: 2 }, { key: 'Backspace', span: 1 }]
            ];
            var PROFILES_KEY = 'analyzer:profiles';
            var SETTINGS_KEY = 'analyzer:settings';
            var PALETTES = { 'CIAN': '#00FFFF', 'FUEGO': '#FF4500', 'JUNGLA': '#228B22', 'GALAXIA': '#8A2BE2' };
            var PALETTE_KEYS = Object.keys(PALETTES);
            var MASTERY_COLORS = { 'SUMAS': '#228B22', 'RESTAS': '#00008B', 'MULTIPLICACION': '#8A2BE2', 'DIVISIONES': '#FF4500' };
            
            var RANK_NAMES = [ '', 'Cadete Novato', 'Alférez Iniciado', 'Teniente Junior', 'Teniente Comandante', 'Comandante Prime', 'Capitán Explorador', 'Capitán de Flota', 'Comodoro Estelar', 'Contralmirante', 'Vicealmirante', 'Almirante Supremo', 'Almirante de Flota', 'Gran Almirante', 'Comandante de la Flota Estelar', 'Mariscal de la Federación', 'Canciller Supremo' ];
            var MASTERY_NAMES = { 'SUMAS': 'Maestro de Operaciones Tácticas', 'RESTAS': 'Comandante de Defensa Estratégica', 'MULTIPLICACION': 'Experto de División Científica', 'DIVISIONES': 'Especialista del Cuerpo de Ingeniería' };
            
            var RANK_SHAPES = [ '', `<path d="M10 50 L30 40 L50 50" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<path d="M10 50 L30 40 L50 50 M10 65 L30 55 L50 65" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<path d="M10 40 L30 30 L50 40 M10 55 L30 45 L50 55 M10 70 L30 60 L50 70" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%"/>`, `<polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%"/><path d="M10 70 L30 60 L50 70" stroke="%%COLOR%%" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<polygon points="30,15 38,30 55,30 42,40 47,55 30,45 13,55 18,40 5,30 22,30" fill="%%COLOR%%" transform="translate(0, 15)"/>`, `<path d="M20,65 L10,60 L10,30 L20,25 L40,25 L50,30 L50,60 L40,65 Z" fill="none" stroke="%%COLOR%%" stroke-width="4"/><polygon points="30,35 34,43.5 43,43.5 36,49 38,58 30,53 22,58 24,49 17,43.5 26,43.5" fill="%%COLOR%%"/>`, `<path d="M5,55 L5,25 L30,10 L55,25 L55,55 L30,70 Z" fill="none" stroke="%%COLOR%%" stroke-width="5" stroke-linejoin="round"/> <path d="M15,50 L15,30 L30,20 L45,30 L45,50 L30,60 Z" fill="%%COLOR%%" stroke="#1A1A1A" stroke-width="1"/>`, `<g transform="translate(0, 5)"><path d="M5,50 L30,25 L55,50 L30,75 Z" fill="%%COLOR%%"/><path d="M15,50 L30,35 L45,50 L30,65 Z" fill="#1A1A1A"/></g>`, `<g transform="translate(0, 5)"><path d="M5,50 L30,20 L55,50 L30,80 Z" stroke="%%COLOR%%" stroke-width="4" fill="none"/><polygon points="30,35 35,45 45,45 37.5,51 40,60 30,54 20,60 22.5,51 15,45 25,45" fill="%%COLOR%%"/></g>`, `<g transform="translate(0, 5)"><path d="M10,20 L50,20 L55,45 L30,70 L5,45 Z" fill="%%COLOR%%"/><polygon points="30,30 34,40 42,40 35,45 37,54 30,49 23,54 25,45 18,40 26,40" fill="#1A1A1A"/></g>`, `<g transform="translate(0,5)"><path d="M10,15 L50,15 L58,45 L30,75 L2,45 Z" fill="none" stroke="%%COLOR%%" stroke-width="5"/><polygon points="30,25 34,35 42,35 35,40 37,49 30,44 23,49 25,40 18,35 26,35" fill="%%COLOR%%"/><path d="M20,60 L30,50 L40,60" stroke="%%COLOR%%" stroke-width="4" fill="none" stroke-linecap="round"/></g>`, `<g transform="translate(0,10)"><circle cx="30" cy="40" r="22" stroke="%%COLOR%%" stroke-width="5" fill="none"/><polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%" transform="scale(0.8) translate(7, 5)"/></g>`, `<g><path d="M2,45 C2,20 15,15 30,15 C45,15 58,20 58,45 L30,75 Z" fill="%%COLOR%%"/><polygon points="30,30 36.5,43.5 51,43.5 39.25,52.5 43.5,66.5 30,57.5 16.5,66.5 20.75,52.5 9,43.5 23.5,43.5" fill="#1A1A1A" transform="scale(0.6) translate(20, 15)"/></g>`, `<g><path d="M5,15 L55,15 L50,45 L30,75 L10,45 Z" fill="none" stroke="%%COLOR%%" stroke-width="5"/><path d="M15,25 L45,25 L42,45 L30,65 L18,45 Z" fill="%%COLOR%%" stroke="#1A1A1A" stroke-width="1.5"/></g>`, `<g><path d="M5,10 L55,10 L55,50 L30,80 L5,50 Z" stroke="#FFD700" stroke-width="4" fill="none"/><path d="M15,20 L45,20 L45,45 L30,65 L15,45 Z" fill="%%COLOR%%"/><polygon points="30,28 34,38 42,38 35,43 37,52 30,47 23,52 25,43 18,38 26,38" fill="#FFD700"/></g>` ];
            
            var ESCALADO_DE_DIFICULTAD = { 'SUMAS': [ {min: 1, max: 9}, {min: 5, max: 15}, {min: 10, max: 25}, {min: 20, max: 50}, {min: 40, max: 80}, {min: 60, max: 100}, {min: 80, max: 120}, {min: 90, max: 120} ], 'RESTAS': [ {n1_min: 10, n1_max: 15, n2_min: 1, n2_max: 9}, {n1_min: 15, n1_max: 25, n2_min: 5, n2_max: 14}, {n1_min: 25, n1_max: 40, n2_min: 10, n2_max: 24}, {n1_min: 40, n1_max: 70, n2_min: 15, n2_max: 39}, {n1_min: 70, n1_max: 100, n2_min: 20, n2_max: 69}, {n1_min: 80, n1_max: 120, n2_min: 30, n2_max: 79}, {n1_min: 100, n1_max: 120, n2_min: 50, n2_max: 99}, {n1_min: 100, n1_max: 120, n2_min: 10, n2_max: 99} ], 'MULTIPLICACION': [ {min: 1, max: 4}, {min: 2, max: 5}, {min: 2, max: 7}, {min: 3, max: 8}, {min: 3, max: 10}, {min: 5, max: 11}, {min: 5, max: 12}, {min: 8, max: 12} ], 'DIVISIONES': [ {min: 1, max: 4}, {min: 2, max: 5}, {min: 2, max: 7}, {min: 3, max: 8}, {min: 3, max: 10}, {min: 5, max: 11}, {min: 5, max: 12}, {min: 8, max: 12} ] };

            function saveSettings() { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings)); } catch (e) { console.error('[ERR][STORAGE] FALLO AL GUARDAR CONFIGURACIÓN.', e); } }
            function loadSettings() { try { var stored = localStorage.getItem(SETTINGS_KEY); if(stored) { state.settings = JSON.parse(stored); } else { state.settings = getDefaultSettings(); } } catch (e) { console.error('[ERR][STORAGE] FALLO AL CARGAR CONFIGURACIÓN. APLICANDO VALORES POR DEFECTO.', e); state.settings = getDefaultSettings(); } }
            function saveProfilesToStorage() { try { localStorage.setItem(PROFILES_KEY, JSON.stringify(state.profiles)); } catch (e) { console.error('[ERR][STORAGE] FALLO AL GUARDAR PERFILES.', e); } }
            function createDefaultProfile() { console.log('[STORAGE][INFO] NO SE ENCONTRARON PERFILES. CREANDO PERFIL POR DEFECTO...'); state.profiles = { 'PILOTO_DE_PRUEBAS': getEmptyProfileData() }; saveProfilesToStorage(); }
            function loadProfilesFromStorage() { try { var storedData = localStorage.getItem(PROFILES_KEY); if (!storedData) { createDefaultProfile(); return; } var d = JSON.parse(storedData); if (typeof d !== 'object' || d === null || Object.keys(d).length === 0) { createDefaultProfile(); return; } var p = {}; var n = Object.keys(d); n.forEach(function(pn) { var op = d[pn] || {}; p[pn] = { solvedQuestions: op.solvedQuestions || { 'SUMAS': [], 'RESTAS': [], 'MULTIPLICACION': [], 'DIVISIONES': [] }, perfectRuns: op.perfectRuns || { 'SUMAS': false, 'RESTAS': false, 'MULTIPLICACION': false, 'DIVISIONES': false }, aciertos: op.aciertos || 0, errores: op.errores || 0 }; }); state.profiles = p; } catch (e) { console.error('[ERR][STORAGE] DATOS DE PERFIL CORRUPTOS. CREANDO NUEVO SET DE PERFILES.', e); createDefaultProfile(); } }
            
            function showWindow(windowId) {
                if (state.currentWindow === windowId) return;

                ui.glitchOverlay.classList.add('active');
                
                setTimeout(function() {
                    if (windowId !== 'insignias') {
                        state.previousWindow = state.currentWindow;
                    }
                    for (var id in windows) {
                        windows[id].classList.remove('active');
                    }
                    if (windows[windowId]) {
                        windows[windowId].classList.add('active');
                    }
                    state.currentWindow = windowId;

                    setTimeout(function() {
                        ui.glitchOverlay.classList.remove('active');
                    }, 50);
                }, 300);
            }

            function requestFullscreen() { var e = document.documentElement; if (e.requestFullscreen) e.requestFullscreen(); else if (e.mozRequestFullScreen) e.mozRequestFullScreen(); else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen(); else if (e.msRequestFullscreen) e.msRequestFullscreen(); }
            function handleFullscreenChange() { var isFs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; if (!isFs && state.currentWindow !== 'preload' && state.currentWindow !== 'title') { windows.fullscreenOverlay.classList.add('active'); } else { windows.fullscreenOverlay.classList.remove('active'); } }
            
            function calculateLayout() {
                var keyboardWidth = Math.min(window.innerWidth * 0.85, 550);
                var gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap-m')) || 8;
                var keySize = (keyboardWidth - (7 * gap)) / 8;
                ui.virtualKeyboard.style.setProperty('--k', keySize + 'px');
            }
            
            function renderPlayerKeyboard() {
                ui.virtualKeyboard.innerHTML = '';
                PLAYER_KEYBOARD_LAYOUT.forEach(function(row) {
                    row.forEach(function(keyData) {
                        var key, span;
                        if (typeof keyData === 'object') { key = keyData.key; span = keyData.span; } else { key = keyData; span = 1; }
                        var e = document.createElement('button');
                        e.className = 'interactive-button key';
                        e.setAttribute('data-key', key);
                        if (span > 1) { e.style.gridColumn = 'span ' + span; }
                        var t = key;
                        if (key === 'Backspace') t = '←';
                        else if (key === 'Enter') t = '↵';
                        else if (key === 'Shift') t = '⇧';
                        
                        if (state.isShiftActive && key.length === 1) { t = t.toUpperCase(); } 
                        else if (!state.isShiftActive && key.length === 1) { t = t.toLowerCase(); }
                        
                        if (key === 'Shift' && state.isShiftActive) {
                            e.classList.add('shift-active');
                        }
                        
                        e.textContent = t;
                        ui.virtualKeyboard.appendChild(e);
                    });
                });
            }

            function renderProfiles() { ui.profilesList.innerHTML = ''; Object.keys(state.profiles).forEach(function(pn) { var li = document.createElement('li'); li.className = 'profile-entry'; var pb = document.createElement('button'); pb.className = 'interactive-button profile-button'; pb.textContent = pn; pb.setAttribute('data-profile-name', pn); var db = document.createElement('button'); db.className = 'delete-button'; db.textContent = 'X'; db.setAttribute('data-profile-name', pn); li.appendChild(pb); li.appendChild(db); ui.profilesList.appendChild(li); }); }
            function createInsigniaSVG(shape, color) { var base = `<svg viewBox="0 0 60 90" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 H60 V75 L30 90 L0 75 Z" fill="#141414" stroke="#0A0A0A" stroke-width="2"/>`; var coloredShape = shape.replace(/%%COLOR%%/g, color); return base + coloredShape + '</svg>'; }
            function renderProfileRank() { if (!state.activeProfile) return; var profile = state.profiles[state.activeProfile]; var totalSolved = 0; var categories = Object.keys(profile.solvedQuestions); for (var i = 0; i < categories.length; i++) { totalSolved += profile.solvedQuestions[categories[i]].length; } var rankIndex = Math.floor(totalSolved / 5); rankIndex = Math.min(rankIndex, RANK_SHAPES.length - 1); var insigniaShape = RANK_SHAPES[rankIndex]; ui.profileDisplayName.textContent = state.activeProfile; if(insigniaShape) { ui.rankInsigniaDisplay.innerHTML = createInsigniaSVG(insigniaShape, '#FFD700'); } else { ui.rankInsigniaDisplay.innerHTML = ''; } }
            function renderProfileStats() {
                if (!state.activeProfile) return;
                var profile = state.profiles[state.activeProfile];
                var aciertos = profile.aciertos || 0;
                var errores = profile.errores || 0;
                var total = aciertos + errores;
                var precision = (total === 0) ? 0 : (aciertos / total) * 100;

                document.getElementById('statValueAciertos').textContent = aciertos;
                document.getElementById('statValueErrores').textContent = errores;
                document.getElementById('statValuePrecision').textContent = precision.toFixed(1) + '%';
            }
            function populateLevelGrid() { 
                ui.levelGrid.innerHTML = ''; 
                if (!state.activeProfile) return; 
                var profile = state.profiles[state.activeProfile]; 
                Object.keys(ESCALADO_DE_DIFICULTAD).forEach(function(d) { 
                    var b = document.createElement('button'); 
                    b.className = 'interactive-button'; 
                    b.setAttribute('data-difficulty', d); 
                    var content = document.createElement('div'); 
                    content.className = 'level-button-content'; 
                    var solvedInCategory = profile.solvedQuestions[d] ? profile.solvedQuestions[d].length : 0; 
                    var masteryRankIndex = Math.floor(solvedInCategory / 5); 
                    masteryRankIndex = Math.min(masteryRankIndex, RANK_SHAPES.length - 1); 
                    var masteryShape = RANK_SHAPES[masteryRankIndex]; 
                    var masteryInsigniaContainer = document.createElement('div'); 
                    masteryInsigniaContainer.className = 'mastery-insignia'; 
                    if (masteryShape) { 
                        masteryInsigniaContainer.innerHTML = createInsigniaSVG(masteryShape, MASTERY_COLORS[d]); 
                    } 
                    
                    var infoWrapper = document.createElement('div');
                    infoWrapper.className = 'level-info-wrapper';
                    
                    var categoryName = document.createElement('div'); 
                    categoryName.className = 'level-category'; 
                    categoryName.textContent = d; 
                    
                    var starfleetName = document.createElement('div');
                    starfleetName.className = 'level-starfleet-name';
                    var rankName = RANK_NAMES[masteryRankIndex] || '';
                    starfleetName.textContent = rankName;
                    
                    infoWrapper.appendChild(categoryName);
                    infoWrapper.appendChild(starfleetName);
                    
                    var numCubes = solvedInCategory % 5; 
                    var cubesContainer = document.createElement('div'); 
                    cubesContainer.className = 'progress-cubes-container'; 
                    for (var i = 0; i < 4; i++) { 
                        var cube = document.createElement('div'); 
                        cube.className = 'progress-cube' + (i < numCubes ? ' filled' : ''); 
                        cubesContainer.appendChild(cube); 
                    } 
                    content.appendChild(masteryInsigniaContainer); 
                    content.appendChild(infoWrapper); 
                    content.appendChild(cubesContainer); 
                    b.appendChild(content); 
                    ui.levelGrid.appendChild(b); 
                }); 
            }
            
            function renderInsignias() {
                var listContainer = ui.insigniasList;
                var displayContainer = document.querySelector('#insigniaGlyphDisplay');
                var svgContainer = displayContainer.querySelector('.glyph-svg-container');
                var titleContainer = displayContainer.querySelector('.glyph-title');
                
                listContainer.innerHTML = '';
                
                var allInsignias = [];
                RANK_SHAPES.forEach(function(shape, index) {
                    if (index === 0) return;
                    allInsignias.push({
                        title: RANK_NAMES[index] || 'RANGO ' + index,
                        shape: shape,
                        color: '#FFD700'
                    });
                });
                Object.keys(MASTERY_NAMES).forEach(function(category) {
                    allInsignias.push({
                        title: MASTERY_NAMES[category],
                        shape: RANK_SHAPES[16],
                        color: MASTERY_COLORS[category]
                    });
                });

                var docFrag = document.createDocumentFragment();
                allInsignias.forEach(function(insignia) {
                    var item = document.createElement('div');
                    item.className = 'insignia-item';
                    
                    item.dataset.shape = insignia.shape;
                    item.dataset.color = insignia.color;
                    item.dataset.title = insignia.title;

                    var itemSvgContainer = document.createElement('div');
                    itemSvgContainer.className = 'insignia-item-svg';
                    itemSvgContainer.innerHTML = createInsigniaSVG(insignia.shape, insignia.color);

                    var itemTitle = document.createElement('div');
                    itemTitle.className = 'insignia-item-title';
                    itemTitle.textContent = insignia.title;
                    
                    item.appendChild(itemSvgContainer);
                    item.appendChild(itemTitle);
                    docFrag.appendChild(item);
                });
                
                listContainer.appendChild(docFrag);

                function updateGlyphDisplay(shape, color, title) {
                    svgContainer.innerHTML = createInsigniaSVG(shape, color);
                    titleContainer.textContent = title;
                }

                listContainer.addEventListener('mouseover', function(e) {
                    var targetItem = e.target.closest('.insignia-item');
                    if (targetItem) {
                        updateGlyphDisplay(targetItem.dataset.shape, targetItem.dataset.color, targetItem.dataset.title);
                    }
                });
                
                if (allInsignias.length > 0) {
                    updateGlyphDisplay(allInsignias[0].shape, allInsignias[0].color, allInsignias[0].title);
                } else {
                    svgContainer.innerHTML = '';
                    titleContainer.textContent = 'NO HAY INSIGNIAS';
                }
            }

            function applyPalette(index) { if (typeof PALETTE_KEYS === 'undefined' || !PALETTE_KEYS) return; var key = PALETTE_KEYS[index]; if (key) { document.body.style.setProperty('--color-accent-primary', PALETTES[key]); } }
            function updateSoundToggleButtons() { var text = 'SONIDO: ' + (state.settings.soundEnabled ? 'ON' : 'OFF'); document.querySelectorAll('.sound-toggle-button').forEach(function(btn) { btn.textContent = text; }); }
            function renderPaletteSubMenus() { document.querySelectorAll('.palette-submenu').forEach(function(submenu) { submenu.innerHTML = ''; if (typeof PALETTE_KEYS === 'undefined' || !PALETTE_KEYS) return; PALETTE_KEYS.forEach(function(key, index) { var button = document.createElement('button'); button.textContent = key; button.setAttribute('data-palette-index', index); if (typeof PALETTES !== 'undefined' && PALETTES[key]) { button.style.color = PALETTES[key]; } submenu.appendChild(button); }); }); }
            
            var PRNG = { seed: function(s) { state.quiz.prngState = s >>> 0; }, next: function() { var x = state.quiz.prngState; x ^= x << 13; x ^= x >> 17; x ^= x << 5; state.quiz.prngState = x; return (x >>> 0) / 0x100000000; } };

            function numberToLiteral(n, gender) {
                var unidades = ['cero', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
                var especiales = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'dieciséis', 'diecisiete', 'dieciocho', 'diecinueve'];
                var decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
                if (n === 1) { return gender === 'f' ? 'una' : 'un'; }
                if (n >= 0 && n < 10) { return unidades[n]; }
                if (n >= 10 && n < 20) { return especiales[n - 10]; }
                if (n >= 20 && n < 30) { return n === 20 ? 'veinte' : 'veinti' + unidades[n-20]; }
                if (n >= 30 && n < 100) { var d = Math.floor(n / 10); var u = n % 10; return decenas[d] + (u > 0 ? ' y ' + unidades[u] : ''); }
                if (n === 100) { return 'cien'; }
                if (n > 100 && n < 200) { return 'ciento ' + numberToLiteral(n - 100, gender); }
                return String(n);
            }

            var QuestionGenerator = {
                thematicPacks: [
                    {
                        tema: "PARQUE",
                        personajes: ["Sofía", "Mateo"],
                        sujetos: [{p: "flores", s: "flor", g: "f", cont: {p:"ramos", s:"ramo"}}, {p: "hojas", s: "hoja", g: "f", cont: {p:"montones", s:"montón"}}],
                        templates: {
                            'SUMAS': ["{personaje} coleccionaba {sujeto_p} y ya tenía {n1}. Mientras caminaba por el parque, encontró {n2} más. ¿Cuántas {sujeto_p} tiene ahora?", "En un jardín, un grupo de {n1} {sujeto_p} crecía junto a otro grupo de {n2} {sujeto_p}. ¿Cuántas hay en total?"],
                            'RESTAS': ["{personaje} tenía un ramo con {n1} {sujeto_p}, pero se le cayeron {n2} por el camino. ¿Cuántas {sujeto_p} le quedan en el ramo?", "Un árbol tenía {n1} {sujeto_p} en una rama. El viento sopló e hizo caer {n2}. ¿Cuántas {sujeto_p} permanecen en la rama?"],
                            'MULTIPLICACION': ["{personaje} hizo {n1} {cont_p}. Si en cada {cont_s} colocó {n2} {sujeto_p}, ¿cuántas {sujeto_p} usó en total?", "En el parque hay {n1} macetas y cada una tiene {n2} {sujeto_p}. ¿Cuántas {sujeto_p} hay en total?"],
                            'DIVISIONES': [
                                { template: "{personaje} quiere repartir {total} {sujeto_p} en {n1} {cont_p} iguales. ¿Cuántas {sujeto_p} pondrá en cada {cont_s}?", answer: 'n2' },
                                { template: "Si {personaje} tiene {total} {sujeto_p} y hace {cont_p} con {n2} {sujeto_p} cada uno, ¿cuántos {cont_p} podrá hacer?", answer: 'n1' }
                            ]
                        }
                    },
                    {
                        tema: "FIESTA",
                        personajes: ["Leo", "Valentina"],
                        sujetos: [{p: "globos", s: "globo", g: "m", cont: {p:"grupos", s:"grupo"}}, {p: "caramelos", s: "caramelo", g: "m", cont: {p:"bolsas", s:"bolsa"}}],
                        templates: {
                            'SUMAS': ["En una fiesta, {personaje} infló {n1} {sujeto_p} y luego infló {n2} más. ¿Cuántos {sujeto_p} infló en total?", "Valentina recibió {n1} {sujeto_p} en una bolsa y {n2} en otra. ¿Cuántos {sujeto_p} tiene en total?"],
                            'RESTAS': ["{personaje} tenía {n1} {sujeto_p}, pero se le explotaron {n2}. ¿Cuántos {sujeto_p} le quedaron?", "De una bolsa con {n1} {sujeto_p}, Leo repartió {n2} a sus amigos. ¿Cuántos le quedaron?"],
                            'MULTIPLICACION': ["{personaje} preparó {n1} {cont_p} de sorpresas. Si cada una tiene {n2} {sujeto_p}, ¿cuántos {sujeto_p} usó?", "Para decorar, se hicieron {n1} {cont_p} de {n2} {sujeto_p} cada uno. ¿Cuántos {sujeto_p} se usaron?"],
                            'DIVISIONES': [
                                { template: "{personaje} quiere repartir {total} {sujeto_p} entre {n1} amigos. ¿Cuántos {sujeto_p} le tocarán a cada uno?", answer: 'n2' },
                                { template: "Si Valentina tiene {total} {sujeto_p} y los guarda en {cont_p} de {n2}, ¿cuántas {cont_p} necesitará?", answer: 'n1' }
                            ]
                        }
                    },
                    {
                        tema: "TIENDA",
                        personajes: ["Laura", "Daniel"],
                        sujetos: [{p: "juguetes", s: "juguete", g: "m", cont: {p:"cajas", s:"caja"}}, {p: "libros", s: "libro", g: "m", cont: {p:"estantes", s:"estante"}}],
                        templates: {
                           'SUMAS': ["En un estante de la tienda había {n1} {sujeto_p}. Un repartidor colocó {n2} {sujeto_p} adicionales. ¿Cuántos {sujeto_p} hay ahora?", "{personaje} compró {n1} {sujeto_p} y su amigo le regaló {n2} más. ¿Cuántos tiene en total?"],
                           'RESTAS': ["Había {n1} {sujeto_p} en una caja, pero {personaje} vendió {n2}. ¿Cuántos {sujeto_p} quedan en la caja?", "De {n1} {sujeto_p} que tenía una tienda, se devolvieron {n2} por estar defectuosos. ¿Cuántos quedaron para la venta?"],
                           'MULTIPLICACION': ["Una tienda recibió {n1} {cont_p} y cada una contenía {n2} {sujeto_p}. ¿Cuántos {sujeto_p} llegaron en total?", "Si Daniel organiza los {sujeto_p} en {n1} {cont_p} con {n2} {sujeto_p} en cada uno, ¿cuántos {sujeto_p} ha organizado?"],
                           'DIVISIONES': [
                               { template: "Una fábrica empaqueta {total} {sujeto_p} en {cont_p}. Si en cada {cont_s} caben {n2} {sujeto_p}, ¿cuántas {cont_p} se necesitarán?", answer: 'n1' },
                               { template: "{personaje} debe acomodar {total} {sujeto_p} en {n1} {cont_p} de forma equitativa. ¿Cuántos {sujeto_p} irán en cada {cont_s}?", answer: 'n2' }
                           ]
                        }
                    }
                ],
                getRandomElement: function(arr) { return arr[Math.floor(PRNG.next() * arr.length)]; },
                getRandomNumber: function(min, max) { return Math.floor(PRNG.next() * (max - min + 1)) + min; },
                populateTemplate: function(template, context) { var populated = template; for (var key in context) { var regex = new RegExp('{' + key + '}', 'g'); populated = populated.replace(regex, context[key]); } return populated; },
                generateOptions: function(correctAnswer) {
                    var options = [correctAnswer];
                    while (options.length < 4) { var offset = this.getRandomNumber(1, 10) * (PRNG.next() > 0.5 ? 1 : -1); var distractor = correctAnswer + offset; if (options.indexOf(distractor) === -1 && distractor >= 0 && distractor !== correctAnswer) { options.push(distractor); } }
                    for (var i = options.length - 1; i > 0; i--) { var j = Math.floor(PRNG.next() * (i + 1)); var temp = options[i]; options[i] = options[j]; options[j] = temp; }
                    return options;
                },
                createQuestion: function(type) {
                    var profile = state.activeProfile ? state.profiles[state.activeProfile] : null;
                    var solvedInCategory = profile ? (profile.solvedQuestions[type] ? profile.solvedQuestions[type].length : 0) : 0;
                    var masteryRankIndex = Math.floor(solvedInCategory / 5);
                    var difficultyConfig = ESCALADO_DE_DIFICULTAD[type][Math.min(masteryRankIndex, ESCALADO_DE_DIFICULTAD[type].length - 1)];
                    
                    var pack = this.getRandomElement(this.thematicPacks);
                    var sujeto = this.getRandomElement(pack.sujetos);
                    var personaje = this.getRandomElement(pack.personajes);
                    var n1, n2, correctAnswer, total, template, templateObj;
                    var context = {};
                    
                    var templateArray = pack.templates[type];

                    if (type === 'SUMAS') {
                        n1 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max); n2 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max);
                        correctAnswer = n1 + n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'RESTAS') {
                        n1 = this.getRandomNumber(difficultyConfig.n1_min, difficultyConfig.n1_max); n2 = this.getRandomNumber(difficultyConfig.n2_min, Math.min(n1 - 1, difficultyConfig.n2_max));
                        correctAnswer = n1 - n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'MULTIPLICACION') {
                        n1 = this.getRandomNumber(2, 5); n2 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max);
                        if (PRNG.next() > 0.5) { var temp = n1; n1 = n2; n2 = temp; }
                        correctAnswer = n1 * n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'DIVISIONES') {
                        n1 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max); n2 = this.getRandomNumber(2, 5);
                        if (n1 === 0 || n2 === 0) { n2 = 2; }
                        total = n1 * n2;
                        context.total = (PRNG.next() > 0.5) ? numberToLiteral(total, sujeto.g) : total;
                        templateObj = this.getRandomElement(templateArray);
                        template = templateObj.template;
                        correctAnswer = (templateObj.answer === 'n1') ? n1 : n2;
                    }

                    context.personaje = personaje; 
                    context.n1 = (PRNG.next() > 0.5) ? numberToLiteral(n1, sujeto.g) : n1;
                    context.n2 = (PRNG.next() > 0.5) ? numberToLiteral(n2, sujeto.g) : n2;
                    context.sujeto_p = sujeto.p; context.sujeto_s = sujeto.s;
                    context.cont_p = sujeto.cont.p; context.cont_s = sujeto.cont.s;
                    
                    var questionText = this.populateTemplate(template, context);
                    var options = this.generateOptions(correctAnswer);

                    if (PRNG.next() < 0.20) { 
                        var pos = correctAnswer - 1;
                        if (pos >= 0 && pos < questionText.length) {
                            questionText = questionText.substring(0, pos) + questionText.charAt(pos).toUpperCase() + questionText.substring(pos + 1);
                        }
                    }

                    return { id: type + ':' + new Date().getTime(), question: questionText, options: options, correctAnswerIndex: options.indexOf(correctAnswer) };
                }
            };
            
            var QuizManager = {
                startQuiz: function(d) {
                    function fnv1a(str) { for(var i = 0, h = 0x811c9dc5; i < str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 0x01000193); return h; }
                    var seed = fnv1a(state.activeProfile + d + state.profiles[state.activeProfile].solvedQuestions[d].length + new Date().getTime());
                    PRNG.seed(seed);
                    ui.gameHudPlayerName.textContent = 'JUGADOR :: ' + state.activeProfile;
                    var questionData = QuestionGenerator.createQuestion(d);
                    state.quiz.currentQuestion = questionData;
                    state.quiz.currentDifficulty = d;
                    state.quiz.isAnswered = false;
                    this.updateHud();
                    this.renderQuizUI();
                    EventBus.emit('system:requestNavigation', { windowId: 'game' });
                },
                handleAnswer: function(selectedIndex) {
                    if (state.quiz.isAnswered) return;
                    clearInterval(state.quiz.timerId);
                    state.quiz.isAnswered = true;
                    var isCorrect = selectedIndex === state.quiz.currentQuestion.correctAnswerIndex;
                    var optionButtons = ui.quizOptions.querySelectorAll('.option-button');
                    if (selectedIndex >= 0) { optionButtons[selectedIndex].classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer'); }
                    if (isCorrect) { 
                        AudioManager.playSound('success'); 
                        state.quiz.streak++;
                        var buttonRect = optionButtons[selectedIndex].getBoundingClientRect();
                        var centerX = buttonRect.left + buttonRect.width / 2;
                        var centerY = buttonRect.top + buttonRect.height / 2;
                        createCelebrationParticles(centerX, centerY);
                    } else { 
                        AudioManager.playSound('error'); 
                        state.quiz.streak = 0; 
                        if (optionButtons[state.quiz.currentQuestion.correctAnswerIndex]) {
                            optionButtons[state.quiz.currentQuestion.correctAnswerIndex].classList.add('correct-answer');
                        } 
                        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) { 
                            ui.glitchWrapper.classList.add('glitch-active'); 
                            ui.holographicPanel.classList.add('error-flash'); 
                            setTimeout(function() { 
                                ui.glitchWrapper.classList.remove('glitch-active'); 
                                ui.holographicPanel.classList.remove('error-flash'); 
                            }, 300); 
                        } 
                    }
                    this.updateHud();
                    optionButtons.forEach(function(btn) { btn.disabled = true; });
                    this.endQuiz(isCorrect);
                },
                endQuiz: function(wasCorrect) {
                    var profile = state.profiles[state.activeProfile];
                    var difficulty = state.quiz.currentDifficulty;
                    if (wasCorrect) {
                        profile.aciertos++;
                        if (profile.solvedQuestions[difficulty].indexOf(state.quiz.currentQuestion.id) === -1) { 
                            profile.solvedQuestions[difficulty].push(state.quiz.currentQuestion.id); 
                        }
                    } else { 
                        profile.errores++;
                        profile.perfectRuns[difficulty] = false; 
                    }
                    saveProfilesToStorage();
                    setTimeout(function() {
                        if (wasCorrect) { EventBus.emit('quiz:victory'); } else { var correctAnswerText = state.quiz.currentQuestion.options[state.quiz.currentQuestion.correctAnswerIndex]; EventBus.emit('quiz:defeat', { correctAnswer: 'LA RESPUESTA CORRECTA ERA: ' + correctAnswerText }); }
                    }, 1500);
                },
                updateHud: function() {
                    ui.gameHudStreak.textContent = "RACHA: " + state.quiz.streak;
                    var timePercentage = (state.quiz.timerValue / QUESTION_TIME) * 100;
                    ui.timeBarFill.style.width = timePercentage + '%';
                    ui.timeBarFill.classList.remove('warning', 'critical');
                    if (timePercentage < 25) { ui.timeBarFill.classList.add('critical'); } 
                    else if (timePercentage < 50) { ui.timeBarFill.classList.add('warning'); }
                },
                startTimer: function() {
                    state.quiz.timerValue = QUESTION_TIME;
                    this.updateHud();
                    state.quiz.timerId = setInterval(function() {
                        state.quiz.timerValue--;
                        QuizManager.updateHud();
                        if (state.quiz.timerValue < 0) {
                            clearInterval(state.quiz.timerId);
                            QuizManager.handleAnswer(-1);
                        }
                    }, 1000);
                },
                renderQuizUI: function() {
                    ui.quizQuestion.textContent = state.quiz.currentQuestion.question;
                    ui.quizOptions.innerHTML = '';
                    state.quiz.currentQuestion.options.forEach(function(option, index) {
                        var button = document.createElement('button');
                        button.className = 'interactive-button option-button';
                        button.textContent = option;
                        button.setAttribute('data-option-index', index);
                        ui.quizOptions.appendChild(button);
                    });
                    this.startTimer();
                }
            };
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[BOOT][INFO] INICIALIZANDO QUIZ v6.5.1 (CORE UPDATE)...');
                loadSettings(); loadProfilesFromStorage(); applyPalette(state.settings.paletteIndex); updateSoundToggleButtons(); 
                calculateLayout();
                renderPlayerKeyboard(); 
                renderPaletteSubMenus();
                
                function advanceToProfiles() { AudioManager.init(); EventBus.emit('system:requestNavigation', { windowId: 'profiles', requestFullscreen: true }); }
                windows.title.addEventListener('click', advanceToProfiles); document.addEventListener('keydown', advanceToProfiles, { once: true });
                
                ui.reEnterFullscreenButton.addEventListener('click', function() { EventBus.emit('system:requestFullscreen'); });
                ui.goToPlayerCreateButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'player' }); });
                ui.cancelPlayerButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'profiles' }); });
                ui.backToProfilesButton.addEventListener('click', function() { EventBus.emit('profile:clearActive'); });
                ui.victoryToMenuButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'mainMenu', fromVictory: true }); });
                ui.gameOverToMenuButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'mainMenu' }); });
                ui.profilesList.addEventListener('click', function(e) { var n = e.target.getAttribute('data-profile-name'); if (!n) return; if (e.target.classList.contains('profile-button')) { EventBus.emit('profile:selected', { profileName: n }); } else if (e.target.classList.contains('delete-button')) { EventBus.emit('profile:deleted', { profileName: n }); } });
                ui.virtualKeyboard.addEventListener('click', function(e) { var k = e.target.getAttribute('data-key'); if (!k || !e.target.classList.contains('key')) return; EventBus.emit('player:input', { key: k }); });
                ui.levelGrid.addEventListener('click', function(e) { var b = e.target.closest('button[data-difficulty]'); if (b) { EventBus.emit('quiz:start', { difficulty: b.getAttribute('data-difficulty') }); } });
                ui.quizOptions.addEventListener('click', function(e) { var btn = e.target.closest('.option-button'); if (btn && !state.quiz.isAnswered) { AudioManager.playSound('tick'); EventBus.emit('quiz:answer', { selectedIndex: parseInt(btn.getAttribute('data-option-index'), 10) }); } });
                
                document.querySelectorAll('.settings-button').forEach(function(b) { b.addEventListener('click', function(e) { e.stopPropagation(); var menu = document.getElementById(e.target.getAttribute('data-menu-id')); var isActive = menu.classList.contains('active'); document.querySelectorAll('.settings-menu').forEach(function(m) { m.classList.remove('active'); }); if (!isActive) { menu.classList.add('active'); } }); });
                document.querySelectorAll('.sound-toggle-button').forEach(function(b) { b.addEventListener('click', function() { state.settings.soundEnabled = !state.settings.soundEnabled; updateSoundToggleButtons(); saveSettings(); }); });
                document.querySelectorAll('.palette-toggle-button').forEach(function(b) { b.addEventListener('click', function(e) { e.stopPropagation(); e.target.parentElement.classList.toggle('open'); }); });
                document.querySelectorAll('.palette-submenu').forEach(function(s) { s.addEventListener('click', function(e) { if(e.target.hasAttribute('data-palette-index')) { state.settings.paletteIndex = parseInt(e.target.getAttribute('data-palette-index'), 10); applyPalette(state.settings.paletteIndex); saveSettings(); } }); });
                document.querySelectorAll('.close-session-button').forEach(function(b) { b.addEventListener('click', function() { EventBus.emit('system:closeSession'); }); });
                document.querySelectorAll('.insignias-button').forEach(function(b) { b.addEventListener('click', function() { EventBus.emit('insignias:show'); }); });
                ui.closeInsigniasButton.addEventListener('click', function() { EventBus.emit('insignias:hide'); });
                
                document.body.addEventListener('click', function() { document.querySelectorAll('.settings-menu.active, .palette-container.open').forEach(function(m) { m.classList.remove('active', 'open'); }); });
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) { document.body.addEventListener('mousemove', function(e) { var x = (e.clientX / window.innerWidth) - 0.5, y = (e.clientY / window.innerHeight) - 0.5, rx = y * -5, ry = x * 5; if(ui.holographicPanel) ui.holographicPanel.style.transform = 'rotateX(' + (10 + rx) + 'deg) rotateY(' + ry + 'deg)'; }); }
                
                window.addEventListener('resize', calculateLayout);
                document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); document.addEventListener('mozfullscreenchange', handleFullscreenChange); document.addEventListener('MSFullscreenChange', handleFullscreenChange);
                
                EventBus.on('system:requestNavigation', function(d) { AudioManager.playSound('navigate'); if(d.requestFullscreen) requestFullscreen(); if(d.fromVictory || d.windowId === 'mainMenu') { renderProfileRank(); populateLevelGrid(); renderProfileStats(); } if(d.windowId === 'profiles') { renderProfiles(); } showWindow(d.windowId); });
                EventBus.on('system:requestFullscreen', function() { AudioManager.playSound('navigate'); requestFullscreen(); });
                EventBus.on('system:closeSession', function() { AudioManager.playSound('navigate'); document.querySelectorAll('.settings-menu').forEach(function(m) { m.classList.remove('active'); }); if (state.currentWindow === 'game') { clearInterval(state.quiz.timerId); showWindow('mainMenu'); } else { state.activeProfile = null; showWindow('profiles'); } });
                EventBus.on('profile:selected', function(d) { AudioManager.playSound('navigate'); state.activeProfile = d.profileName; state.quiz.streak = 0; renderProfileRank(); populateLevelGrid(); renderProfileStats(); showWindow('mainMenu'); });
                EventBus.on('profile:deleted', function(d) { AudioManager.playSound('error'); delete state.profiles[d.profileName]; saveProfilesToStorage(); renderProfiles(); });
                EventBus.on('profile:clearActive', function() { AudioManager.playSound('navigate'); state.activeProfile = null; showWindow('profiles'); });
                
                EventBus.on('player:input', function(d) {
                    AudioManager.playSound('tick');
                    var nameDisplay = ui.playerNameDisplay;
                    nameDisplay.classList.remove('shake', 'error-flash');

                    if (d.key === 'Backspace') {
                        state.newPlayerName = state.newPlayerName.slice(0, -1);
                    } else if (d.key === 'Enter') {
                        var n = state.newPlayerName.trim();
                        if (n && !state.profiles[n]) {
                            state.profiles[n] = getEmptyProfileData();
                            saveProfilesToStorage();
                            renderProfiles();
                            showWindow('profiles');
                            state.newPlayerName = '';
                        } else {
                            void nameDisplay.offsetWidth;
                            nameDisplay.classList.add('error-flash');
                        }
                    } else if (d.key === 'Shift') {
                        state.isShiftActive = !state.isShiftActive;
                        renderPlayerKeyboard();
                    } else {
                        if (state.newPlayerName.length < 12 && d.key.length === 1) {
                            var char = d.key;
                            state.newPlayerName += state.isShiftActive ? char.toUpperCase() : char.toLowerCase();
                        } else if (state.newPlayerName.length >= 12) {
                            void nameDisplay.offsetWidth;
                            nameDisplay.classList.add('shake');
                        }
                    }
                    ui.playerNameText.textContent = state.newPlayerName;
                    nameDisplay.style.setProperty('--chars', state.newPlayerName.length);
                });

                EventBus.on('quiz:start', function(d) { QuizManager.startQuiz(d.difficulty); });
                EventBus.on('quiz:answer', function(d) { QuizManager.handleAnswer(d.selectedIndex); });
                EventBus.on('quiz:victory', function() { 
                    if (state.activeProfile) {
                        var profile = state.profiles[state.activeProfile];
                        var totalSolved = 0;
                        var categories = Object.keys(profile.solvedQuestions);
                        for (var i = 0; i < categories.length; i++) {
                            totalSolved += profile.solvedQuestions[categories[i]].length;
                        }
                        var rankIndex = Math.floor(totalSolved / 5);
                        rankIndex = Math.min(rankIndex, RANK_SHAPES.length - 1);
                        var insigniaShape = RANK_SHAPES[rankIndex];
                        
                        var display3d = document.getElementById('insignia3dDisplay');
                        if (display3d && insigniaShape) {
                            display3d.innerHTML = createInsigniaSVG(insigniaShape, '#FFD700');
                        }
                    }
                    showWindow('victory'); 
                });
                EventBus.on('quiz:defeat', function(d) { ui.gameOverCorrectAnswer.textContent = d.correctAnswer; showWindow('gameOver'); });
                EventBus.on('insignias:show', function() { document.querySelectorAll('.settings-menu').forEach(function(m) { m.classList.remove('active'); }); renderInsignias(); showWindow('insignias'); });
                EventBus.on('insignias:hide', function() { showWindow(state.previousWindow); });
                
                var hoveredLevelCategory = null;

                ui.levelGrid.addEventListener('mouseover', function(e) {
                    var button = e.target.closest('button[data-difficulty]');
                    if (button) {
                        hoveredLevelCategory = button.getAttribute('data-difficulty');
                    }
                });

                ui.levelGrid.addEventListener('mouseout', function(e) {
                    hoveredLevelCategory = null;
                });

                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
                        if (state.currentWindow === 'mainMenu' && hoveredLevelCategory && state.activeProfile) {
                            console.log('[EGG] Combinación secreta activada para: ' + hoveredLevelCategory);
                            var profile = state.profiles[state.activeProfile];
                            if (profile) {
                                for (var i = 0; i < 5; i++) {
                                    profile.solvedQuestions[hoveredLevelCategory].push('EGG_' + Date.now() + i);
                                }
                                
                                saveProfilesToStorage();
                                populateLevelGrid();
                                renderProfileRank();
                                AudioManager.playSound('success');
                            }
                        }
                    }
                });
                
                setTimeout(function() { showWindow('title'); }, 1000);
                console.log('[BOOT][INFO] PREFLIGHT OK. SISTEMA TOTALMENTE COMPATIBLE CON MANIFIESTO.');
            });
        })();
    </script>
</body>
</html>
