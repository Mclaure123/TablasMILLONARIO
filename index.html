<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERMINAL QUIZ v8.0.2 - EDICIÓN EXPANDIDA (6 PERSONAJES, 6 OBJETOS)</title>
    <style>
        :root {
            --color-bg-primary: #0A0A0A; --color-surface: #141414; --color-func: #2A2A2A; --color-text-passive: #B0B0B0; --color-text-bright: #FFFFFF; --color-accent-primary: #00FFFF; --color-accent-bios: #00FF8A; --color-error: #FF414B; --color-success: #39FF14; --color-accent-gold: #FFD700; --color-warning: #FFD300;
            --gap-s: clamp(4px, 1vmin, 8px);
            --gap-m: clamp(8px, 2vmin, 16px);
            --gap-l: clamp(16px, 4vmin, 32px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; font-size: clamp(10px, 2.5vmin, 22px); }
        body { width: 100%; height: 100%; overflow: hidden; background-color: var(--color-bg-primary); color: var(--color-text-bright); font-family: Consolas, Menlo, Courier New, monospace; font-size: 1rem; position: relative; }
        
        /* MEJORA 1: Gradientes animados de fondo */
        body::before { 
            content: ""; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.08) 0%, transparent 50%), 
                radial-gradient(circle at 80% 20%, rgba(0, 255, 138, 0.06) 0%, transparent 50%), 
                radial-gradient(circle at 50% 80%, rgba(255, 215, 0, 0.04) 0%, transparent 50%),
                linear-gradient(var(--color-surface) 1px, transparent 1px), 
                linear-gradient(90deg, var(--color-surface) 1px, transparent 1px); 
            background-size: 100% 100%, 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            pointer-events: none; 
            z-index: 0; 
            animation: holographic-pulse 8s ease-in-out infinite;
            opacity: 0.5;
        }
        @keyframes holographic-pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }
        #perspective-container { perspective: 1200px; width: 100%; height: 100%; position: relative; }
        body::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.5) 0px, rgba(0,0,0,0.4) 1px, transparent 2px, transparent 3px); z-index: 10; animation: scanline-scroll 20s linear infinite; }
        @keyframes scanline-scroll { to { background-position-y: 100%; } }
        main { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-style: preserve-3d; }
        
        .window { width: 100%; height: 100%; padding: 0 var(--gap-l); position: absolute; top: 0; left: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; opacity: 0; transform: translateX(-100px) translateZ(-200px); pointer-events: none; visibility: hidden; transition: opacity 400ms cubic-bezier(0.4, 0, 0.2, 1), transform 400ms cubic-bezier(0.4, 0, 0.2, 1), visibility 400ms; }
        .window.active { opacity: 1; transform: translateX(0) translateZ(0px); pointer-events: auto; visibility: visible; }
        
        .window-content { flex-grow: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--gap-m) 0; min-height: 0; }
        #preload, #title, #victory, #gameOver, #timeOut, #auth { justify-content: center; padding: var(--gap-m) var(--gap-l); }
        /* MEJORA 5: Tipografía holográfica multicapa */
        h1 { font-size: clamp(2rem, 10vmin, 5rem); color: var(--color-accent-primary); letter-spacing: clamp(4px, 1vmin, 8px); text-shadow: 0 0 10px var(--color-accent-primary), 0 0 20px rgba(0, 255, 255, 0.7), 0 0 40px rgba(0, 255, 255, 0.4), 0 0 60px rgba(0, 255, 255, 0.2); max-width: 100%; word-break: break-word; animation: glow-pulse-h1 3s ease-in-out infinite; }
        @keyframes glow-pulse-h1 { 0%, 100% { text-shadow: 0 0 10px var(--color-accent-primary), 0 0 20px rgba(0, 255, 255, 0.7), 0 0 40px rgba(0, 255, 255, 0.4); } 50% { text-shadow: 0 0 15px var(--color-accent-primary), 0 0 30px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.5), 0 0 80px rgba(0, 255, 255, 0.3); } }
        h2 { font-size: clamp(1.5rem, 6vmin, 3rem); color: var(--color-text-bright); margin-bottom: var(--gap-m); display: flex; align-items: center; justify-content: center; }
        p { font-size: clamp(0.8rem, 2.5vmin, 1.1rem); color: var(--color-text-passive); max-width: 90%; line-height: 1.6; }
        
        /* MEJORA 2 y 3: Glassmorphism + Animaciones fluidas */
        .interactive-button, button { 
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.7) 0%, rgba(26, 26, 26, 0.7) 100%);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 2px solid rgba(0, 255, 255, 0.3);
            color: var(--color-text-bright); 
            padding: var(--gap-s) var(--gap-m); 
            font-family: inherit; 
            font-size: clamp(0.9rem, 2.5vmin, 1.2rem); 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: all 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
            flex-shrink: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .interactive-button::before, button::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        /* MEJORA 4: Efectos avanzados en hover */
        .interactive-button:hover, button:hover { 
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(37, 37, 37, 0.9) 100%);
            border-color: var(--color-accent-primary); 
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 255, 255, 0.4), 0 0 40px rgba(0, 255, 255, 0.2);
            text-shadow: 0 0 10px var(--color-accent-primary);
        }
        .interactive-button:hover::before, button:hover::before {
            width: 300px;
            height: 300px;
        }
        .interactive-button:active, button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .interactive-button:focus-visible, button:focus-visible { 
            outline: 3px solid var(--color-accent-bios); 
            outline-offset: 2px; 
        }
        .interactive-button:disabled, button:disabled { 
            background: var(--color-func); 
            border-color: #222; 
            color: #444; 
            cursor: not-allowed; 
            opacity: 0.4; 
            filter: grayscale(80%); 
            transform: scale(0.95); 
        }
        
        .telemetry-header { width: 100%; flex-shrink: 0; text-transform: uppercase; color: var(--color-text-passive); font-size: clamp(0.7rem, 2vmin, 0.9rem); letter-spacing: 2px; display: flex; justify-content: space-between; align-items: center; padding: var(--gap-s); border-bottom: 1px solid var(--color-surface); position: relative; }
        .telemetry-footer { padding: var(--gap-s); border-top: 1px solid var(--color-surface); }
        .telemetry-group { display: flex; align-items: center; gap: var(--gap-m); }
        .settings-button { background: none; border: none; font-size: clamp(1.2rem, 4vmin, 1.8rem); color: var(--color-text-passive); cursor: pointer; padding: 0 var(--gap-s); transition: color 220ms, transform 220ms; }
        .settings-button:hover { color: var(--color-accent-primary); transform: rotate(90deg); }
        
        #settingsModal {
            background-color: rgba(10, 10, 10, 0.9);
            z-index: 1000;
        }
        .settings-panel {
            background: var(--color-bg-primary);
            border: 2px solid var(--color-surface);
            padding: var(--gap-l);
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: var(--gap-l);
        }
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: var(--gap-m);
            align-items: flex-start;
            text-align: left;
            border-top: 1px solid var(--color-surface);
            padding-top: var(--gap-m);
        }
        .settings-section:first-child { border-top: none; padding-top: 0; }
        .settings-section h3 {
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--color-accent-primary);
        }
        .palette-options { display: flex; gap: var(--gap-m); }
        .palette-swatch {
            width: 40px;
            height: 40px;
            border: 2px solid var(--color-surface);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .palette-swatch:hover { transform: scale(1.1); }
        .palette-swatch.active { border-color: var(--color-accent-bios); }

        #auth-text { font-size: clamp(1.2rem, 4vmin, 1.8rem); letter-spacing: 2px; }
        #auth-text .cursor { display: inline-block; background-color: var(--color-accent-bios); width: 0.6ch; height: 1em; animation: blink 1s steps(2, start) infinite; }
        
        #categoryInfoPanel {
            position: absolute;
            right: var(--gap-l);
            top: 50%;
            transform: translateY(-50%) translateX(100%);
            width: 300px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--color-surface);
            padding: var(--gap-m);
            text-align: left;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        #categoryInfoPanel.active {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }
        .info-item { display: flex; justify-content: space-between; font-size: clamp(0.8rem, 2vmin, 1rem); }
        .info-label { color: var(--color-text-passive); }
        .info-value { color: var(--color-text-bright); font-weight: bold; }
        #infoValueTitle { color: var(--color-accent-primary); }

        @keyframes particle-burst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        .celebration-particle {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--particle-color, var(--color-accent-bios));
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: particle-burst 1s ease-out forwards;
            box-shadow: 0 0 10px var(--particle-color, var(--color-accent-bios));
        }
        
        #glitch-wrapper.glitch-active { animation: glitch-error-effect 300ms ease-in-out; }
        @keyframes glitch-error-effect { 0%, 100% { transform: translate(0, 0); } 10% { transform: translate(-5px, -3px) skewX(-5deg); } 30% { transform: translate(3px, 5px) skewX(5deg); } 50% { transform: translate(-3px, -5px); } 70% { transform: translate(5px, 3px); } 90% { transform: translate(-3px, 3px) skewX(-2deg); } }
        #holographic-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--gap-m); transform-style: preserve-3d; transform: rotateX(10deg); transition: transform 0.1s linear; filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.4)); width: 100%; max-width: 100%; }
        #holographic-panel.error-flash { filter: drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)) blur(1px); }
        #profilesList { list-style: none; margin-bottom: var(--gap-m); display: flex; flex-direction: column; gap: var(--gap-s); max-height: 50vh; width: 100%; max-width: 450px; }
        .profile-entry { display: flex; gap: var(--gap-s); align-items: center; }
        .profile-button { flex-grow: 1; text-align: left; padding-left: 20px;}
        .delete-button { width: clamp(38px, 10vmin, 48px); height: clamp(38px, 10vmin, 48px); padding: 0; font-size: clamp(1rem, 4vmin, 1.5rem); flex-shrink: 0; background-color: var(--color-error); border-color: #8B0000; }
        #levelGrid { display: flex; flex-direction: column; gap: var(--gap-m); max-width: 550px; width: 100%; }
        #levelGrid button { 
            padding: var(--gap-m); 
            font-size: clamp(0.9rem, 3vmin, 1.2rem); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 70px;
        }
        #levelGrid button::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: lcars-scan 4s linear infinite;
        }
        @keyframes lcars-scan {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        .level-button-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            gap: var(--gap-m);
            z-index: 1;
            position: relative;
        }
        .level-info-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
            gap: 4px;
        }
        .level-category {
            font-size: clamp(1rem, 3.5vmin, 1.4rem);
            font-weight: bold;
            letter-spacing: 2px;
            color: var(--color-text-bright);
        }
        .level-starfleet-name {
            font-size: clamp(0.7rem, 2vmin, 0.9rem);
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }
        .level-title { flex-grow: 1; text-align: left; }
        .progress-cubes-container { display: flex; gap: 4px; }
        .progress-cube { 
            width: clamp(8px, 2vmin, 12px); 
            height: clamp(8px, 2vmin, 12px); 
            border: 1px solid var(--color-surface); 
            background-color: transparent;
            transition: all 0.3s ease;
        }
        .progress-cube.filled { 
            background: radial-gradient(circle, var(--color-accent-bios) 0%, rgba(34,139,34,0.7) 100%);
            box-shadow: 0 0 6px var(--color-accent-bios);
            animation: pulse-cube 2s ease-in-out infinite;
        }
        @keyframes pulse-cube {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #profileStatsContainer {
            display: flex;
            gap: var(--gap-l);
            background-color: rgba(10, 10, 10, 0.5);
            border: 1px solid var(--color-surface);
            padding: var(--gap-m);
            margin-bottom: var(--gap-l);
            border-radius: 4px;
            font-size: clamp(0.8rem, 2.5vmin, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-label {
            font-size: 0.8em;
            color: var(--color-text-passive);
        }
        .stat-value {
            font-weight: bold;
        }
        #statValueAciertos { color: var(--color-success); }
        #statValueErrores { color: var(--color-error); }
        #statValuePrecision { color: var(--color-accent-gold); }

        /* MEJORA 1: Input de nombre más grande y visible */
        #playerNameDisplay { 
            position: relative;
            width: min(90vw, 600px); 
            height: clamp(70px, 12vmin, 120px);
            background: linear-gradient(135deg, var(--color-surface) 0%, #1a1a1a 100%);
            border: 4px solid var(--color-accent-primary); 
            color: var(--color-accent-primary); 
            font-size: clamp(1.8rem, 5vmin, 3rem);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            letter-spacing: 6px; 
            margin-bottom: var(--gap-l);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 0 30px rgba(0, 255, 255, 0.4);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        #playerNameDisplay:hover {
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5), 0 0 40px rgba(0, 255, 255, 0.6);
            border-color: var(--color-accent-bios);
        }
        /* MEJORA 2: Cursor más visible y suave */
        #playerNameDisplay .cursor {
            position: absolute;
            left: calc(50% + (var(--chars, 0) / 2 * 1ch) + 4px);
            width: 0.7ch;
            height: 75%;
            background-color: var(--color-accent-bios);
            animation: blink-smooth 1.2s ease-in-out infinite;
            box-shadow: 0 0 15px var(--color-accent-bios), 0 0 25px rgba(0, 255, 138, 0.5);
        }
        @keyframes blink-smooth { 
            0%, 49% { opacity: 1; } 
            50%, 100% { opacity: 0; } 
        }
        #playerNameDisplay.shake { animation: shake-horizontal 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-horizontal { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #playerNameDisplay.error-flash { animation: flash-error 0.5s ease-out; }
        @keyframes flash-error { 0%, 100% { border-color: var(--color-func); } 50% { border-color: var(--color-error); box-shadow: 0 0 30px rgba(255, 65, 75, 0.6); } }
        
        #virtualKeyboard { 
            display: grid; 
            grid-template-columns: repeat(8, var(--k)); 
            grid-auto-rows: var(--k); 
            gap: var(--gap-m);
            max-width: 90vw;
        }
        #virtualKeyboard .key { 
            padding: 0; 
            font-size: calc(var(--k) * 0.55); 
            text-transform: none;
            font-weight: bold;
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #2e2e2e 0%, #1a1a1a 100%);
            border: 2px solid #3a3a3a;
            position: relative;
        }
        #virtualKeyboard .key:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.3);
            border-color: var(--color-accent-primary);
        }
        /* MEJORA 3: Feedback visual mejorado al presionar teclas */
        #virtualKeyboard .key:active {
            transform: translateY(2px) scale(0.92);
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.6), inset 0 2px 8px rgba(0, 0, 0, 0.5);
            background: linear-gradient(145deg, #1a1a1a 0%, #0e0e0e 100%);
        }
        #virtualKeyboard .key.pressed {
            animation: key-press 0.2s ease-out;
        }
        @keyframes key-press {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(3px) scale(0.9); }
            100% { transform: translateY(0) scale(1); }
        }
        .key[data-key="Enter"] { 
            background: linear-gradient(145deg, var(--color-accent-bios) 0%, #00a060 100%);
            border-color: #006400;
            box-shadow: 0 4px 12px rgba(0, 255, 138, 0.3);
        }
        .key[data-key="Enter"]:hover {
            box-shadow: 0 6px 20px rgba(0, 255, 138, 0.5);
        }
        .key[data-key="Shift"] { 
            background: linear-gradient(145deg, #3a3a3a 0%, #1e1e1e 100%);
        }
        .key[data-key="Shift"].shift-active {
            background: linear-gradient(145deg, var(--color-accent-primary) 0%, #00a0a0 100%);
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            color: #000;
        }
        .key[data-key="Backspace"] {
            background: linear-gradient(145deg, #4a4a4a 0%, #2a2a2a 100%);
        }
        
        #quizQuestion { font-size: clamp(1.2rem, 4vmin, 2rem); color: var(--color-accent-gold); margin-bottom: var(--gap-l); max-width: 900px; line-height: 1.5; }

        #quizOptions { display: grid; grid-template-columns: 1fr; gap: var(--gap-m); width: 100%; max-width: 800px; }
        @media (min-width: 600px) { #quizOptions { grid-template-columns: 1fr 1fr; } }
        
        .option-button { 
            padding: clamp(12px, 3vmin, 24px) var(--gap-m); 
            text-transform: none; 
            font-size: clamp(1.2rem, 4.5vmin, 2rem);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .option-button.correct-answer { 
            background: linear-gradient(135deg, var(--color-success) 0%, #1a8a0d 100%);
            border-color: #0d5a00; 
            color: var(--color-bg-primary);
            animation: pulse-success 0.6s ease-out;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.6);
        }
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .option-button.incorrect-answer { 
            background: linear-gradient(135deg, var(--color-error) 0%, #8B0000 100%);
            border-color: #660000;
            animation: shake-wrong 0.5s ease-out;
        }
        @keyframes shake-wrong {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .option-button.flash-hint {
            animation: flash-hint 700ms ease-out;
        }
        @keyframes flash-hint {
            0%, 100% { border-color: var(--color-surface); box-shadow: 0 4px 16px rgba(0, 255, 255, 0.4); }
            50% { border-color: var(--color-accent-bios); box-shadow: 0 0 40px var(--color-accent-bios); }
        }
        
        .ascii-art-container { width: clamp(90px, 20vmin, 120px); height: clamp(90px, 20vmin, 120px); margin-bottom: var(--gap-m); }
        .centered-hud-item { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        #gameHudPlayerName { color: var(--color-text-passive); }
        #gameHudStreak { 
            color: var(--color-accent-gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        /* CONTADOR DIGITAL DE TIEMPO - ESTILO TERMINAL */
        #digitalTimer { 
            font-family: 'Courier New', Consolas, monospace;
            font-size: clamp(1rem, 3vmin, 1.4rem);
            font-weight: bold;
            color: var(--color-accent-bios);
            text-shadow: 0 0 10px rgba(0, 255, 138, 0.7), 0 0 20px rgba(0, 255, 138, 0.4);
            letter-spacing: 2px;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(0, 20, 15, 0.8) 0%, rgba(0, 15, 10, 0.9) 100%);
            border: 2px solid var(--color-accent-bios);
            border-radius: 6px;
            min-width: 80px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 138, 0.3), inset 0 0 10px rgba(0, 255, 138, 0.1);
        }
        #digitalTimer.warning { 
            color: var(--color-warning);
            border-color: var(--color-warning);
            text-shadow: 0 0 10px rgba(255, 211, 0, 0.7), 0 0 20px rgba(255, 211, 0, 0.4);
            animation: pulse-warning-digital 1s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(255, 211, 0, 0.4), inset 0 0 10px rgba(255, 211, 0, 0.1);
        }
        #digitalTimer.critical { 
            color: var(--color-error);
            border-color: var(--color-error);
            text-shadow: 0 0 10px rgba(255, 65, 75, 0.8), 0 0 20px rgba(255, 65, 75, 0.5);
            animation: pulse-critical-digital 0.5s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 65, 75, 0.5), inset 0 0 10px rgba(255, 65, 75, 0.2);
        }
        @keyframes pulse-warning-digital {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(255, 211, 0, 0.4), inset 0 0 10px rgba(255, 211, 0, 0.1);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 25px rgba(255, 211, 0, 0.7), inset 0 0 15px rgba(255, 211, 0, 0.2);
                transform: scale(1.05);
            }
        }
        @keyframes pulse-critical-digital {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 65, 75, 0.5), inset 0 0 10px rgba(255, 65, 75, 0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(255, 65, 75, 0.9), inset 0 0 20px rgba(255, 65, 75, 0.3);
                transform: scale(1.08);
            }
        }
        
        #rankInsigniaDisplay { display: inline-block; width: 30px; height: 45px; vertical-align: middle; margin-left: var(--gap-m); }
        #rankInsigniaDisplay svg { width: 100%; height: 100%; }
        .mastery-insignia { width: 24px; height: 36px; flex-shrink: 0; }
        .mastery-insignia svg { width: 100%; height: 100%; }
        
        #insigniasContainer {
            display: flex;
            flex-direction: row;
            gap: var(--gap-l);
            width: 100%;
            max-width: 1100px;
            height: 70vh;
        }

        #insigniasList {
            flex: 2;
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--gap-m); 
            padding: var(--gap-m);
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.5) 0%, rgba(10, 10, 10, 0.5) 100%);
            border-radius: 15px;
            border: 2px solid var(--color-surface);
        }

        #insigniaGlyphDisplay {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, #1a1a1a 0%, #0A0A0A 100%);
            border: 2px solid var(--color-accent-primary);
            border-radius: 15px;
            padding: var(--gap-l);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            text-align: center;
        }

        #insigniaGlyphDisplay .glyph-svg-container {
            width: 80%;
            max-width: 200px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #insigniaGlyphDisplay .glyph-svg-container svg {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 20px var(--color-accent-gold));
        }
        #insigniaGlyphDisplay .glyph-title {
            font-size: clamp(1rem, 3vmin, 1.3rem);
            color: var(--color-accent-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: var(--gap-m);
            flex-shrink: 0;
            height: 60px;
        }
        
        .insignia-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            gap: var(--gap-s); 
            text-align: center;
            padding: var(--gap-m);
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.8) 0%, rgba(20, 20, 20, 0.8) 100%);
            border: 2px solid #555;
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .insignia-item:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent-primary);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
        }
        .insignia-item-svg { 
            width: 50px; 
            height: 75px;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
        }
        .insignia-item-title { 
            font-size: clamp(0.8rem, 2vmin, 1rem); 
            color: var(--color-text-bright); 
            font-weight: bold;
            line-height: 1.2;
        }
        
        .victory-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: var(--gap-l); width: 100%; position: relative; }
        
        .teleport-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 400px; pointer-events: none; z-index: 1; }
        .teleport-effect::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 255, 0.1) 20%, rgba(0, 255, 255, 0.2) 40%, rgba(0, 255, 255, 0.3) 50%, rgba(0, 255, 255, 0.2) 60%, rgba(0, 255, 255, 0.1) 80%, transparent 100%); animation: teleport-shimmer 2s ease-in-out infinite; }
        @keyframes teleport-shimmer { 0%, 100% { opacity: 0; transform: translateY(-100%); } 50% { opacity: 1; transform: translateY(100%); } }
        
        .insignia-showcase { width: 150px; height: 200px; perspective: 1000px; position: relative; z-index: 2; margin: var(--gap-l) 0; }
        .insignia-3d-display { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: float-rotate 4s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.6)); }
        .insignia-3d-display svg { width: 100%; height: 100%; }
        @keyframes float-rotate { 0%, 100% { transform: rotateY(0deg) translateY(0px); } 25% { transform: rotateY(90deg) translateY(-10px); } 50% { transform: rotateY(180deg) translateY(0px); } 75% { transform: rotateY(270deg) translateY(-10px); } }
        
        .insignia-showcase::after { content: ""; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 50%; transform: translate(-50%, -50%); animation: orbit-pulse 3s ease-in-out infinite; }
        @keyframes orbit-pulse { 0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; } }
        
        .lcars-info-panel { display: flex; align-items: center; gap: var(--gap-m); padding: var(--gap-m); background: linear-gradient(90deg, rgba(255, 153, 102, 0.1) 0%, rgba(153, 153, 255, 0.1) 100%); border-radius: 20px; border: 2px solid rgba(0, 255, 255, 0.3); position: relative; overflow: hidden; max-width: 600px; }
        .lcars-info-panel::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent); animation: lcars-scan-victory 3s linear infinite; }
        @keyframes lcars-scan-victory { 0% { left: -100%; } 100% { left: 200%; } }
        .lcars-bar { width: 40px; height: 60px; border-radius: 20px; flex-shrink: 0; }
        .lcars-bar.left-bar { background: linear-gradient(180deg, #FF9966 0%, #CC6633 100%); }
        .lcars-bar.right-bar { background: linear-gradient(180deg, #9999FF 0%, #6666CC 100%); }
        .victory-message { font-size: clamp(1rem, 3vmin, 1.3rem); color: var(--color-text-bright); letter-spacing: 2px; z-index: 1; }
        .victory-title { animation: glow-pulse 2s ease-in-out infinite; }
        @keyframes glow-pulse { 0%, 100% { text-shadow: 0 0 10px var(--color-success), 0 0 20px var(--color-success); } 50% { text-shadow: 0 0 20px var(--color-success), 0 0 40px var(--color-success), 0 0 60px var(--color-success); } }
        
        .starfleet-button { background: linear-gradient(135deg, var(--color-accent-primary) 0%, #008B8B 100%); border: 3px solid var(--color-accent-primary); color: #000; font-weight: bold; padding: var(--gap-m) var(--gap-l); font-size: clamp(1rem, 3vmin, 1.3rem); text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; }
        .starfleet-button::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%); transform: rotate(45deg); animation: starfleet-shine 3s linear infinite; }
        @keyframes starfleet-shine { 0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); } 100% { transform: translateX(100%) translateY(100%) rotate(45deg); } }
        .starfleet-button:hover { background: linear-gradient(135deg, #00FFFF 0%, #00CED1 100%); box-shadow: 0 0 30px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.5); transform: translateY(-3px) scale(1.05); }

        #glitchOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg-primary); z-index: 9999; pointer-events: none; opacity: 0; }
        #glitchOverlay.active { opacity: 1; animation: glitch-transition 300ms steps(2, end); }
        @keyframes glitch-transition {
            0% { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); transform: translate(-10px, 0); }
            10% { clip-path: polygon(0 75%, 100% 75%, 100% 75%, 0 75%); transform: translate(5px, 0); }
            20% { clip-path: polygon(0 50%, 100% 50%, 100% 20%, 0 20%); transform: translate(-7px, 0); }
            30% { clip-path: polygon(0 90%, 100% 90%, 100% 90%, 0 90%); transform: translate(10px, 0); }
            40% { clip-path: polygon(0 40%, 100% 40%, 100% 80%, 0 80%); transform: translate(-5px, 0); }
            50% { clip-path: polygon(0 60%, 100% 60%, 100% 60%, 0 60%); transform: translate(3px, 0); }
            60% { clip-path: polygon(0 15%, 100% 15%, 100% 35%, 0 35%); transform: translate(-8px, 0); }
            70% { clip-path: polygon(0 85%, 100% 85%, 100% 85%, 0 85%); transform: translate(4px, 0); }
            80% { clip-path: polygon(0 55%, 100% 55%, 100% 45%, 0 45%); transform: translate(-6px, 0); }
            90% { clip-path: polygon(0 25%, 100% 25%, 100% 30%, 0 30%); transform: translate(8px, 0); }
            100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); transform: translate(0, 0); }
        }

    </style>
</head>
<body>
    <div id="perspective-container">
        <main id="appContainer">
            <div id="preload" class="window active"><H1>CARGANDO...</H1></div>
            <div id="title" class="window"><h1>TERMINAL QUIZ</h1><p>PRESIONA CUALQUIER TECLA PARA CONTINUAR</p></div>
            
            <div id="auth" class="window">
                <p id="auth-text"></p>
            </div>

            <div id="profiles" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: SELECT PROFILE</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button">&#9881;</button></div></header>
                <div class="window-content"><h2>PERFILES DE USUARIO</h2><ul id="profilesList"></ul><button id="goToPlayerCreateButton" class="interactive-button">CREAR NUEVO PERFIL</button></div>
                <footer class="telemetry-footer">BUILD: v8.0.2-expanded-6chars-6objects</footer>
            </div>

            <div id="player" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: CREATE PROFILE</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button">&#9881;</button></div></header>
                <div class="window-content"><h2>NUEVO JUGADOR</h2><div id="playerNameDisplay"><span id="playerNameText"></span><span class="cursor"></span></div><p id="charCounter" style="color: var(--color-text-passive); font-size: clamp(0.9rem, 2.5vmin, 1.1rem); margin-top: var(--gap-s); letter-spacing: 2px;">CARACTERES: <span id="charCount">0</span>/12</p><div id="virtualKeyboard"></div><div style="display: flex; gap: 16px; margin-top: 16px;"><button id="cancelPlayerButton">CANCELAR</button></div></div>
                <footer class="telemetry-footer">BUILD: v8.0.2-expanded-6chars-6objects</footer>
            </div>
            
            <div id="mainMenu" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: MAIN MENU</span><div class="telemetry-group"><div class="status-light"></div><span>SYSTEM ONLINE</span><button class="settings-button">&#9881;</button></div></header>
                <div class="window-content" style="position: relative;">
                    <div id="categoryInfoPanel">
                        <h3 id="infoValueTitle"></h3>
                        <div class="info-item"><span class="info-label">Preguntas Resueltas:</span><span class="info-value" id="infoValueSolved"></span></div>
                        <div class="info-item"><span class="info-label">Rango de Dificultad:</span><span class="info-value" id="infoValueRank"></span></div>
                        <div class="info-item"><span class="info-label">Tiempo Adaptativo:</span><span class="info-value" id="infoValueTime"></span></div>
                    </div>
                    <h2 id="mainMenuHeader">JUGADOR: <span id="profileDisplayName"></span><span id="rankInsigniaDisplay"></span></h2>
                    <div id="profileStatsContainer">
                        <div class="stat-item">
                            <span class="stat-label">Aciertos</span>
                            <span class="stat-value" id="statValueAciertos">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Errores</span>
                            <span class="stat-value" id="statValueErrores">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Precisión</span>
                            <span class="stat-value" id="statValuePrecision">0%</span>
                        </div>
                    </div>
                    <div id="levelGrid"></div><button id="backToProfilesButton" style="margin-top: 16px;">VOLVER A PERFILES</button>
                </div>
                <footer class="telemetry-footer">BUILD: v8.0.2-expanded-6chars-6objects</footer>
            </div>
            
            <div id="game" class="window">
                <header class="telemetry-header">
                    <span id="gameHudStreak">RACHA: 0</span>
                    <span id="gameHudPlayerName" class="centered-hud-item"></span>
                    <div class="telemetry-group">
                        <span id="digitalTimer">00:00</span>
                        <button class="settings-button">&#9881;</button>
                    </div>
                </header>
                <div class="window-content"><div id="glitch-wrapper"><div id="holographic-panel"><h2>CALCULAR</h2><p id="quizQuestion"></p><div id="quizOptions"></div></div></div></div>
                <footer class="telemetry-footer">BUILD: v8.0.2-expanded-6chars-6objects</footer>
            </div>
            
            <div id="victory" class="window">
                <div class="victory-container">
                    <div class="teleport-effect" id="teleportEffect"></div>
                    <div class="insignia-showcase" id="insigniaShowcase">
                        <div class="insignia-3d-display" id="insignia3dDisplay"></div>
                    </div>
                    <h1 style="color: var(--color-success); text-shadow: 0 0 20px var(--color-success);">RESPUESTA CORRECTA</h1>
                    <h2 class="victory-title">VICTORIA</h2>
                    <div class="lcars-info-panel">
                        <div class="lcars-bar left-bar"></div>
                        <p class="victory-message">HAS RESUELTO LA OPERACIÓN.</p>
                        <div class="lcars-bar right-bar"></div>
                    </div>
                    <button id="victoryToMenuButton" class="starfleet-button">TRANSPORTAR AL MENÚ</button>
                </div>
            </div>
            <div id="gameOver" class="window"><div class="ascii-art-container"></div><h1 style="color: var(--color-error);">RESPUESTA INCORRECTA</h1><h2>DERROTA</h2><p id="gameOverCorrectAnswer"></p><button id="gameOverToMenuButton">REINTENTAR DESDE EL MENÚ</button></div>
            
            <div id="timeOut" class="window"><div class="ascii-art-container"></div><h1 style="color: var(--color-warning);">TIEMPO AGOTADO</h1><h2>TRANSMISIÓN INTERRUMPIDA</h2><p>La conexión con el servidor de la Flota Estelar se ha perdido.</p><button id="timeOutToMenuButton">REINTENTAR DESDE EL MENÚ</button></div>

            <div id="insignias" class="window">
                <header class="telemetry-header"><span>TERMINAL QUIZ :: VISUALIZADOR DE INSIGNIAS</span></header>
                <div class="window-content">
                    <h2 style="margin-bottom: var(--gap-l);">COLECCIÓN DE INSIGNIAS</h2>
                    <div id="insigniasContainer">
                        <div id="insigniasList"></div>
                        <div id="insigniaGlyphDisplay">
                            <div class="glyph-svg-container"></div>
                            <div class="glyph-title"></div>
                        </div>
                    </div>
                </div>
                <footer class="telemetry-footer"><button id="closeInsigniasButton">VOLVER</button></footer>
            </div>

            <div id="settingsModal" class="window">
                <div class="settings-panel">
                    <h2>CONFIGURACIÓN DEL SISTEMA</h2>
                    <div class="settings-section">
                        <h3>SONIDO</h3>
                        <button class="sound-toggle-button">SONIDO: ON</button>
                    </div>
                    <div class="settings-section">
                        <h3>PALETA DE COLORES</h3>
                        <div class="palette-options" id="modalPaletteOptions"></div>
                    </div>
                    <div class="settings-section">
                        <h3>ACCIONES</h3>
                        <button class="insignias-button">VISUALIZADOR DE INSIGNIAS</button>
                        <button class="close-session-button">CERRAR SESIÓN DE PERFIL</button>
                    </div>
                    <button id="closeSettingsModalButton">APLICAR Y CERRAR</button>
                </div>
            </div>

            <div id="fullscreenOverlay" class="window" style="z-index: 999; background-color: rgba(0,0,0,0.95);"><h2>MODO PANTALLA COMPLETA REQUERIDO</h2><p>PARA UNA EXPERIENCIA ÓPTIMA, EL SISTEMA REQUIERE OPERAR EN MODO DE PANTALLA COMPLETA.</p><button id="reEnterFullscreenButton">REACTIVAR</button></div>
            
            <div id="glitchOverlay"></div>
        </main>
    </div>
    <script>
        (function() {
            'use strict';
            var BASE_QUESTION_TIME = 40;  // CORREGIDO: Aumentado de 25 a 40 segundos para dar más tiempo de lectura a los niños
            
            function createCelebrationParticles(x, y) {
                var colors = ['#39FF14', '#00FFFF', '#FFD700', '#00FF8A'];
                for (var i = 0; i < 20; i++) {
                    var particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    var color = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.setProperty('--particle-color', color);
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    var angle = (Math.PI * 2 * i) / 20;
                    var distance = 100 + Math.random() * 100;
                    var tx = Math.cos(angle) * distance;
                    var ty = Math.sin(angle) * distance;
                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');
                    document.body.appendChild(particle);
                    setTimeout(function(p) { return function() { if (p.parentNode) p.parentNode.removeChild(p); }; }(particle), 1000);
                }
            }
            
            function createEventBus() { var listeners = {}; return { on: function(eventName, callback) { if (!listeners[eventName]) { listeners[eventName] = []; } listeners[eventName].push(callback); }, off: function(eventName, callback) { if (!listeners[eventName]) return; listeners[eventName] = listeners[eventName].filter(function(cb) { return cb !== callback; }); }, emit: function(eventName, data) { if (!listeners[eventName]) return; listeners[eventName].forEach(function(callback) { callback(data); }); } }; }
            var EventBus = createEventBus();
            var AudioManager = { audioCtx: null, init: function() { if (!this.audioCtx && (window.AudioContext || window.webkitAudioContext)) { try { this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("[AUDIO] Web Audio API not supported.", e); } } }, playSound: function(type) { if (!state.settings.soundEnabled || !this.audioCtx) return; var osc = this.audioCtx.createOscillator(); var gain = this.audioCtx.createGain(); osc.connect(gain); gain.connect(this.audioCtx.destination); var now = this.audioCtx.currentTime; switch(type) { case 'tick': osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break; case 'success': osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.exponentialRampToValueAtTime(1046.50, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break; case 'error': osc.type = 'square'; osc.frequency.setValueAtTime(164.81, now); osc.frequency.exponentialRampToValueAtTime(73.42, now + 0.2); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2); osc.start(now); osc.stop(now + 0.2); break; case 'navigate': osc.type = 'sine'; osc.frequency.setValueAtTime(330, now); osc.frequency.exponentialRampToValueAtTime(660, now + 0.15); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.15); osc.start(now); osc.stop(now + 0.15); break; } } };
            
            function getDefaultSettings() { return { soundEnabled: true, paletteIndex: 0 }; }
            function getEmptyProfileData() { return { solvedQuestions: { 'SUMAS': [], 'RESTAS': [], 'MULTIPLICACION': [], 'DIVISIONES': [] }, perfectRuns: { 'SUMAS': false, 'RESTAS': false, 'MULTIPLICACION': false, 'DIVISIONES': false }, aciertos: 0, errores: 0 }; }

            var state = { currentWindow: 'preload', previousWindow: null, activeProfile: null, profiles: {}, newPlayerName: '', isShiftActive: false, settings: getDefaultSettings(), quiz: { currentDifficulty: null, currentQuestion: null, isAnswered: false, prngState: 0, streak: 0, timerValue: BASE_QUESTION_TIME, timerId: null, totalTime: BASE_QUESTION_TIME } };
            var windows = { preload: document.getElementById('preload'), title: document.getElementById('title'), auth: document.getElementById('auth'), profiles: document.getElementById('profiles'), player: document.getElementById('player'), mainMenu: document.getElementById('mainMenu'), game: document.getElementById('game'), victory: document.getElementById('victory'), gameOver: document.getElementById('gameOver'), timeOut: document.getElementById('timeOut'), insignias: document.getElementById('insignias'), settingsModal: document.getElementById('settingsModal'), fullscreenOverlay: document.getElementById('fullscreenOverlay') };
            var ui = { levelGrid: document.getElementById('levelGrid'), profilesList: document.getElementById('profilesList'), goToPlayerCreateButton: document.getElementById('goToPlayerCreateButton'), mainMenuHeader: document.getElementById('mainMenuHeader'), profileDisplayName: document.getElementById('profileDisplayName'), rankInsigniaDisplay: document.getElementById('rankInsigniaDisplay'), backToProfilesButton: document.getElementById('backToProfilesButton'), playerNameDisplay: document.getElementById('playerNameDisplay'), playerNameText: document.getElementById('playerNameText'), virtualKeyboard: document.getElementById('virtualKeyboard'), cancelPlayerButton: document.getElementById('cancelPlayerButton'), quizQuestion: document.getElementById('quizQuestion'), quizOptions: document.getElementById('quizOptions'), victoryToMenuButton: document.getElementById('victoryToMenuButton'), gameOverToMenuButton: document.getElementById('gameOverToMenuButton'), timeOutToMenuButton: document.getElementById('timeOut').querySelector('button'), gameOverCorrectAnswer: document.getElementById('gameOverCorrectAnswer'), reEnterFullscreenButton: document.getElementById('reEnterFullscreenButton'), holographicPanel: document.getElementById('holographic-panel'), glitchWrapper: document.getElementById('glitch-wrapper'), gameHudPlayerName: document.getElementById('gameHudPlayerName'), gameHudStreak: document.getElementById('gameHudStreak'), digitalTimer: document.getElementById('digitalTimer'), insigniasList: document.getElementById('insigniasList'), closeInsigniasButton: document.getElementById('closeInsigniasButton'), glitchOverlay: document.getElementById('glitchOverlay'), categoryInfoPanel: document.getElementById('categoryInfoPanel'), closeSettingsModalButton: document.getElementById('closeSettingsModalButton'), modalPaletteOptions: document.getElementById('modalPaletteOptions') };
            var PLAYER_KEYBOARD_LAYOUT = [
                ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I'],
                ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K'],
                ['L', 'Ñ', 'Z', 'X', 'C', 'V', 'B', 'N'],
                [{ key: 'Shift', span: 2 }, 'M', 'O', 'P', { key: 'Enter', span: 2 }, { key: 'Backspace', span: 1 }]
            ];
            var PROFILES_KEY = 'analyzer:profiles';
            var SETTINGS_KEY = 'analyzer:settings';
            var PALETTES = { 'CIAN': '#00FFFF', 'FUEGO': '#FF4500', 'JUNGLA': '#228B22', 'GALAXIA': '#8A2BE2' };
            var PALETTE_KEYS = Object.keys(PALETTES);
            var MASTERY_COLORS = { 'SUMAS': '#228B22', 'RESTAS': '#00008B', 'MULTIPLICACION': '#8A2BE2', 'DIVISIONES': '#FF4500' };
            
            var RANK_NAMES = [ '', 'Cadete Novato', 'Alférez Iniciado', 'Teniente Junior', 'Teniente Comandante', 'Comandante Prime', 'Capitán Explorador', 'Capitán de Flota', 'Comodoro Estelar', 'Contralmirante', 'Vicealmirante', 'Almirante Supremo', 'Almirante de Flota', 'Gran Almirante', 'Comandante de la Flota Estelar', 'Mariscal de la Federación', 'Canciller Supremo' ];
            var MASTERY_NAMES = { 'SUMAS': 'Maestro de Operaciones Tácticas', 'RESTAS': 'Comandante de Defensa Estratégica', 'MULTIPLICACION': 'Experto de División Científica', 'DIVISIONES': 'Especialista del Cuerpo de Ingeniería' };
            
            var RANK_SHAPES = [ '', `<path d="M10 50 L30 40 L50 50" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<path d="M10 50 L30 40 L50 50 M10 65 L30 55 L50 65" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<path d="M10 40 L30 30 L50 40 M10 55 L30 45 L50 55 M10 70 L30 60 L50 70" stroke="%%COLOR%%" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%"/>`, `<polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%"/><path d="M10 70 L30 60 L50 70" stroke="%%COLOR%%" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`, `<polygon points="30,15 38,30 55,30 42,40 47,55 30,45 13,55 18,40 5,30 22,30" fill="%%COLOR%%" transform="translate(0, 15)"/>`, `<path d="M20,65 L10,60 L10,30 L20,25 L40,25 L50,30 L50,60 L40,65 Z" fill="none" stroke="%%COLOR%%" stroke-width="4"/><polygon points="30,35 34,43.5 43,43.5 36,49 38,58 30,53 22,58 24,49 17,43.5 26,43.5" fill="%%COLOR%%"/>`, `<path d="M5,55 L5,25 L30,10 L55,25 L55,55 L30,70 Z" fill="none" stroke="%%COLOR%%" stroke-width="5" stroke-linejoin="round"/> <path d="M15,50 L15,30 L30,20 L45,30 L45,50 L30,60 Z" fill="%%COLOR%%" stroke="#1A1A1A" stroke-width="1"/>`, `<g transform="translate(0, 5)"><path d="M5,50 L30,25 L55,50 L30,75 Z" fill="%%COLOR%%"/><path d="M15,50 L30,35 L45,50 L30,65 Z" fill="#1A1A1A"/></g>`, `<g transform="translate(0, 5)"><path d="M5,50 L30,20 L55,50 L30,80 Z" stroke="%%COLOR%%" stroke-width="4" fill="none"/><polygon points="30,35 35,45 45,45 37.5,51 40,60 30,54 20,60 22.5,51 15,45 25,45" fill="%%COLOR%%"/></g>`, `<g transform="translate(0, 5)"><path d="M10,20 L50,20 L55,45 L30,70 L5,45 Z" fill="%%COLOR%%"/><polygon points="30,30 34,40 42,40 35,45 37,54 30,49 23,54 25,45 18,40 26,40" fill="#1A1A1A"/></g>`, `<g transform="translate(0,5)"><path d="M10,15 L50,15 L58,45 L30,75 L2,45 Z" fill="none" stroke="%%COLOR%%" stroke-width="5"/><polygon points="30,25 34,35 42,35 35,40 37,49 30,44 23,49 25,40 18,35 26,35" fill="%%COLOR%%"/><path d="M20,60 L30,50 L40,60" stroke="%%COLOR%%" stroke-width="4" fill="none" stroke-linecap="round"/></g>`, `<g transform="translate(0,10)"><circle cx="30" cy="40" r="22" stroke="%%COLOR%%" stroke-width="5" fill="none"/><polygon points="30,25 36.5,38.5 51,38.5 39.25,47.5 43.5,61.5 30,52.5 16.5,61.5 20.75,47.5 9,38.5 23.5,38.5" fill="%%COLOR%%" transform="scale(0.8) translate(7, 5)"/></g>`, `<g><path d="M2,45 C2,20 15,15 30,15 C45,15 58,20 58,45 L30,75 Z" fill="%%COLOR%%"/><polygon points="30,30 36.5,43.5 51,43.5 39.25,52.5 43.5,66.5 30,57.5 16.5,66.5 20.75,52.5 9,43.5 23.5,43.5" fill="#1A1A1A" transform="scale(0.6) translate(20, 15)"/></g>`, `<g><path d="M5,15 L55,15 L50,45 L30,75 L10,45 Z" fill="none" stroke="%%COLOR%%" stroke-width="5"/><path d="M15,25 L45,25 L42,45 L30,65 L18,45 Z" fill="%%COLOR%%" stroke="#1A1A1A" stroke-width="1.5"/></g>`, `<g><path d="M5,10 L55,10 L55,50 L30,80 L5,50 Z" stroke="#FFD700" stroke-width="4" fill="none"/><path d="M15,20 L45,20 L45,45 L30,65 L15,45 Z" fill="%%COLOR%%"/><polygon points="30,28 34,38 42,38 35,43 37,52 30,47 23,52 25,43 18,38 26,38" fill="#FFD700"/></g>` ];
            
            var ESCALADO_DE_DIFICULTAD = { 'SUMAS': [ {min: 1, max: 9}, {min: 5, max: 15}, {min: 10, max: 25}, {min: 20, max: 50}, {min: 40, max: 80}, {min: 60, max: 100}, {min: 80, max: 120}, {min: 90, max: 120} ], 'RESTAS': [ {n1_min: 10, n1_max: 15, n2_min: 1, n2_max: 9}, {n1_min: 15, n1_max: 25, n2_min: 5, n2_max: 14}, {n1_min: 25, n1_max: 40, n2_min: 10, n2_max: 24}, {n1_min: 40, n1_max: 70, n2_min: 15, n2_max: 39}, {n1_min: 70, n1_max: 100, n2_min: 20, n2_max: 69}, {n1_min: 80, n1_max: 120, n2_min: 30, n2_max: 79}, {n1_min: 100, n1_max: 120, n2_min: 50, n2_max: 99}, {n1_min: 100, n1_max: 120, n2_min: 10, n2_max: 99} ], 'MULTIPLICACION': [ {min: 1, max: 4}, {min: 2, max: 5}, {min: 2, max: 7}, {min: 3, max: 8}, {min: 3, max: 10}, {min: 5, max: 11}, {min: 5, max: 12}, {min: 8, max: 12} ], 'DIVISIONES': [ {min: 1, max: 4}, {min: 2, max: 5}, {min: 2, max: 7}, {min: 3, max: 8}, {min: 3, max: 10}, {min: 5, max: 11}, {min: 5, max: 12}, {min: 8, max: 12} ] };

            function saveSettings() { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings)); } catch (e) { console.error('[ERR][STORAGE] FALLO AL GUARDAR CONFIGURACIÓN.', e); } }
            function loadSettings() { try { var stored = localStorage.getItem(SETTINGS_KEY); if(stored) { state.settings = JSON.parse(stored); } else { state.settings = getDefaultSettings(); } } catch (e) { console.error('[ERR][STORAGE] FALLO AL CARGAR CONFIGURACIÓN. APLICANDO VALORES POR DEFECTO.', e); state.settings = getDefaultSettings(); } }
            function saveProfilesToStorage() { try { localStorage.setItem(PROFILES_KEY, JSON.stringify(state.profiles)); } catch (e) { console.error('[ERR][STORAGE] FALLO AL GUARDAR PERFILES.', e); } }
            function createDefaultProfile() { console.log('[STORAGE][INFO] NO SE ENCONTRARON PERFILES. CREANDO PERFIL POR DEFECTO...'); state.profiles = { 'PILOTO_DE_PRUEBAS': getEmptyProfileData() }; saveProfilesToStorage(); }
            function loadProfilesFromStorage() { try { var storedData = localStorage.getItem(PROFILES_KEY); if (!storedData) { createDefaultProfile(); return; } var d = JSON.parse(storedData); if (typeof d !== 'object' || d === null || Object.keys(d).length === 0) { createDefaultProfile(); return; } var p = {}; var n = Object.keys(d); n.forEach(function(pn) { var op = d[pn] || {}; p[pn] = { solvedQuestions: op.solvedQuestions || { 'SUMAS': [], 'RESTAS': [], 'MULTIPLICACION': [], 'DIVISIONES': [] }, perfectRuns: op.perfectRuns || { 'SUMAS': false, 'RESTAS': false, 'MULTIPLICACION': false, 'DIVISIONES': false }, aciertos: op.aciertos || 0, errores: op.errores || 0 }; }); state.profiles = p; } catch (e) { console.error('[ERR][STORAGE] DATOS DE PERFIL CORRUPTOS. CREANDO NUEVO SET DE PERFILES.', e); createDefaultProfile(); } }
            
            function showWindow(windowId) {
                if (state.currentWindow === windowId) return;
                ui.glitchOverlay.classList.add('active');
                
                setTimeout(function() {
                    state.previousWindow = state.currentWindow;
                    
                    for (var id in windows) {
                        windows[id].classList.remove('active');
                    }
                    if (windows[windowId]) {
                        windows[windowId].classList.add('active');
                    }
                    state.currentWindow = windowId;

                    setTimeout(function() {
                        ui.glitchOverlay.classList.remove('active');
                    }, 50);
                }, 300);
            }

            function requestFullscreen() { var e = document.documentElement; if (e.requestFullscreen) e.requestFullscreen(); else if (e.mozRequestFullScreen) e.mozRequestFullScreen(); else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen(); else if (e.msRequestFullscreen) e.msRequestFullscreen(); }
            function handleFullscreenChange() { 
                var isFs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; 
                if (!isFs && state.currentWindow !== 'preload' && state.currentWindow !== 'title') { 
                    // Intentar restaurar pantalla completa automáticamente
                    setTimeout(function() {
                        requestFullscreen();
                    }, 100);
                } 
            }
            
            function calculateLayout() {
                var keyboardWidth = Math.min(window.innerWidth * 0.85, 550);
                var gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap-m')) || 8;
                var keySize = (keyboardWidth - (7 * gap)) / 8;
                ui.virtualKeyboard.style.setProperty('--k', keySize + 'px');
                // FIX: Actualizar también el display del nombre del jugador
                ui.playerNameDisplay.style.setProperty('--k', keySize + 'px');
            }
            
            function renderPlayerKeyboard() {
                ui.virtualKeyboard.innerHTML = '';
                PLAYER_KEYBOARD_LAYOUT.forEach(function(row) {
                    row.forEach(function(keyData) {
                        var key, span;
                        if (typeof keyData === 'object') { key = keyData.key; span = keyData.span; } else { key = keyData; span = 1; }
                        var e = document.createElement('button');
                        e.className = 'interactive-button key';
                        e.setAttribute('data-key', key);
                        if (span > 1) { e.style.gridColumn = 'span ' + span; }
                        var t = key;
                        if (key === 'Backspace') t = '←';
                        else if (key === 'Enter') t = '↵';
                        else if (key === 'Shift') t = '⇧';
                        
                        if (state.isShiftActive && key.length === 1) { t = t.toUpperCase(); } 
                        else if (!state.isShiftActive && key.length === 1) { t = t.toLowerCase(); }
                        
                        if (key === 'Shift' && state.isShiftActive) {
                            e.classList.add('shift-active');
                        }
                        
                        e.textContent = t;
                        ui.virtualKeyboard.appendChild(e);
                    });
                });
            }

            function renderProfiles() { ui.profilesList.innerHTML = ''; Object.keys(state.profiles).forEach(function(pn) { var li = document.createElement('li'); li.className = 'profile-entry'; var pb = document.createElement('button'); pb.className = 'interactive-button profile-button'; pb.textContent = pn; pb.setAttribute('data-profile-name', pn); var db = document.createElement('button'); db.className = 'delete-button'; db.textContent = 'X'; db.setAttribute('data-profile-name', pn); li.appendChild(pb); li.appendChild(db); ui.profilesList.appendChild(li); }); }
            function createInsigniaSVG(shape, color) { var base = `<svg viewBox="0 0 60 90" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 H60 V75 L30 90 L0 75 Z" fill="#141414" stroke="#0A0A0A" stroke-width="2"/>`; var coloredShape = shape.replace(/%%COLOR%%/g, color); return base + coloredShape + '</svg>'; }
            function renderProfileRank() { if (!state.activeProfile) return; var profile = state.profiles[state.activeProfile]; var totalSolved = 0; var categories = Object.keys(profile.solvedQuestions); for (var i = 0; i < categories.length; i++) { totalSolved += profile.solvedQuestions[categories[i]].length; } var rankIndex = Math.floor(totalSolved / 5); rankIndex = Math.min(rankIndex, RANK_SHAPES.length - 1); var insigniaShape = RANK_SHAPES[rankIndex]; ui.profileDisplayName.textContent = state.activeProfile; if(insigniaShape) { ui.rankInsigniaDisplay.innerHTML = createInsigniaSVG(insigniaShape, '#FFD700'); } else { ui.rankInsigniaDisplay.innerHTML = ''; } }
            
            function animateCounter(element, finalValue, duration) {
                var startValue = parseInt(element.textContent) || 0;
                var range = finalValue - startValue;
                if (range === 0) { element.textContent = finalValue; return; }
                var startTime = null;

                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    var progress = timestamp - startTime;
                    var increment = Math.min(progress / duration, 1);
                    element.textContent = Math.floor(increment * range + startValue);
                    if (increment < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        element.textContent = finalValue;
                    }
                }
                window.requestAnimationFrame(step);
            }

            function renderProfileStats() {
                if (!state.activeProfile) return;
                var profile = state.profiles[state.activeProfile];
                var aciertos = profile.aciertos || 0;
                var errores = profile.errores || 0;
                var total = aciertos + errores;
                var precision = (total === 0) ? 0 : (aciertos / total) * 100;
                
                animateCounter(document.getElementById('statValueAciertos'), aciertos, 800);
                animateCounter(document.getElementById('statValueErrores'), errores, 800);
                document.getElementById('statValuePrecision').textContent = precision.toFixed(1) + '%';
            }

            function populateLevelGrid() { 
                ui.levelGrid.innerHTML = ''; 
                if (!state.activeProfile) return; 
                var profile = state.profiles[state.activeProfile]; 
                Object.keys(ESCALADO_DE_DIFICULTAD).forEach(function(d) { 
                    var b = document.createElement('button'); 
                    b.className = 'interactive-button'; 
                    b.setAttribute('data-difficulty', d); 
                    var content = document.createElement('div'); 
                    content.className = 'level-button-content'; 
                    var solvedInCategory = profile.solvedQuestions[d] ? profile.solvedQuestions[d].length : 0; 
                    var masteryRankIndex = Math.floor(solvedInCategory / 5); 
                    masteryRankIndex = Math.min(masteryRankIndex, RANK_SHAPES.length - 1); 
                    var masteryShape = RANK_SHAPES[masteryRankIndex]; 
                    var masteryInsigniaContainer = document.createElement('div'); 
                    masteryInsigniaContainer.className = 'mastery-insignia'; 
                    if (masteryShape) { 
                        masteryInsigniaContainer.innerHTML = createInsigniaSVG(masteryShape, MASTERY_COLORS[d]); 
                    } 
                    
                    var infoWrapper = document.createElement('div');
                    infoWrapper.className = 'level-info-wrapper';
                    
                    var categoryName = document.createElement('div'); 
                    categoryName.className = 'level-category'; 
                    categoryName.textContent = d; 
                    
                    var starfleetName = document.createElement('div');
                    starfleetName.className = 'level-starfleet-name';
                    var rankName = RANK_NAMES[masteryRankIndex] || '';
                    starfleetName.textContent = rankName;
                    
                    infoWrapper.appendChild(categoryName);
                    infoWrapper.appendChild(starfleetName);
                    
                    var numCubes = solvedInCategory % 5; 
                    var cubesContainer = document.createElement('div'); 
                    cubesContainer.className = 'progress-cubes-container'; 
                    for (var i = 0; i < 4; i++) { 
                        var cube = document.createElement('div'); 
                        cube.className = 'progress-cube' + (i < numCubes ? ' filled' : ''); 
                        cubesContainer.appendChild(cube); 
                    } 
                    content.appendChild(masteryInsigniaContainer); 
                    content.appendChild(infoWrapper); 
                    content.appendChild(cubesContainer); 
                    b.appendChild(content); 
                    ui.levelGrid.appendChild(b); 
                }); 
            }
            
            function renderInsignias() {
                var listContainer = ui.insigniasList;
                var displayContainer = document.querySelector('#insigniaGlyphDisplay');
                var svgContainer = displayContainer.querySelector('.glyph-svg-container');
                var titleContainer = displayContainer.querySelector('.glyph-title');
                
                listContainer.innerHTML = '';
                
                var allInsignias = [];
                RANK_SHAPES.forEach(function(shape, index) {
                    if (index === 0) return;
                    allInsignias.push({
                        title: RANK_NAMES[index] || 'RANGO ' + index,
                        shape: shape,
                        color: '#FFD700'
                    });
                });
                Object.keys(MASTERY_NAMES).forEach(function(category) {
                    allInsignias.push({
                        title: MASTERY_NAMES[category],
                        shape: RANK_SHAPES[16],
                        color: MASTERY_COLORS[category]
                    });
                });

                var docFrag = document.createDocumentFragment();
                allInsignias.forEach(function(insignia) {
                    var item = document.createElement('div');
                    item.className = 'insignia-item';
                    
                    item.dataset.shape = insignia.shape;
                    item.dataset.color = insignia.color;
                    item.dataset.title = insignia.title;

                    var itemSvgContainer = document.createElement('div');
                    itemSvgContainer.className = 'insignia-item-svg';
                    itemSvgContainer.innerHTML = createInsigniaSVG(insignia.shape, insignia.color);

                    var itemTitle = document.createElement('div');
                    itemTitle.className = 'insignia-item-title';
                    itemTitle.textContent = insignia.title;
                    
                    item.appendChild(itemSvgContainer);
                    item.appendChild(itemTitle);
                    docFrag.appendChild(item);
                });
                
                listContainer.appendChild(docFrag);

                function updateGlyphDisplay(shape, color, title) {
                    svgContainer.innerHTML = createInsigniaSVG(shape, color);
                    titleContainer.textContent = title;
                }

                listContainer.addEventListener('mouseover', function(e) {
                    var targetItem = e.target.closest('.insignia-item');
                    if (targetItem) {
                        updateGlyphDisplay(targetItem.dataset.shape, targetItem.dataset.color, targetItem.dataset.title);
                    }
                });
                
                if (allInsignias.length > 0) {
                    updateGlyphDisplay(allInsignias[0].shape, allInsignias[0].color, allInsignias[0].title);
                } else {
                    svgContainer.innerHTML = '';
                    titleContainer.textContent = 'NO HAY INSIGNIAS';
                }
            }

            function applyPalette(index) { 
                if (typeof PALETTE_KEYS === 'undefined' || !PALETTE_KEYS) return; 
                var key = PALETTE_KEYS[index]; 
                if (key) { 
                    document.body.style.setProperty('--color-accent-primary', PALETTES[key]); 
                    var swatches = document.querySelectorAll('.palette-swatch');
                    swatches.forEach(function(sw) { sw.classList.remove('active'); });
                    var activeSwatch = document.querySelector('.palette-swatch[data-palette-index="' + index + '"]');
                    if (activeSwatch) activeSwatch.classList.add('active');
                }
            }
            function updateSoundToggleButtons() { var text = 'SONIDO: ' + (state.settings.soundEnabled ? 'ON' : 'OFF'); document.querySelectorAll('.sound-toggle-button').forEach(function(btn) { btn.textContent = text; }); }
            function renderPaletteModalOptions() { 
                ui.modalPaletteOptions.innerHTML = ''; 
                if (typeof PALETTE_KEYS === 'undefined' || !PALETTE_KEYS) return; 
                PALETTE_KEYS.forEach(function(key, index) { 
                    var swatch = document.createElement('div');
                    swatch.className = 'palette-swatch';
                    swatch.setAttribute('data-palette-index', index);
                    swatch.style.backgroundColor = PALETTES[key];
                    if (index === state.settings.paletteIndex) {
                        swatch.classList.add('active');
                    }
                    ui.modalPaletteOptions.appendChild(swatch);
                });
            }
            
            var PRNG = { seed: function(s) { state.quiz.prngState = s >>> 0; }, next: function() { var x = state.quiz.prngState; x ^= x << 13; x ^= x >> 17; x ^= x << 5; state.quiz.prngState = x; return (x >>> 0) / 0x100000000; } };

            function numberToLiteral(n, gender) {
                var unidades = ['cero', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
                var especiales = ['diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'dieciséis', 'diecisiete', 'dieciocho', 'diecinueve'];
                var decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
                if (n === 1) { return gender === 'f' ? 'una' : 'un'; }
                if (n >= 0 && n < 10) { return unidades[n]; }
                if (n >= 10 && n < 20) { return especiales[n - 10]; }
                if (n >= 20 && n < 30) { return n === 20 ? 'veinte' : 'veinti' + unidades[n-20]; }
                if (n >= 30 && n < 100) { var d = Math.floor(n / 10); var u = n % 10; return decenas[d] + (u > 0 ? ' y ' + unidades[u] : ''); }
                if (n === 100) { return 'cien'; }
                if (n > 100 && n < 200) { return 'ciento ' + numberToLiteral(n - 100, gender); }
                return String(n);
            }

            var QuestionGenerator = {
                thematicPacks: [
                    {
                        tema: "PARQUE",
                        personajes: ["Sofía", "Mateo", "Isabella", "Lucas", "Valentina", "Sebastián"],
                        sujetos: [
                            {p: "flores", s: "flor", g: "f", cont: {p:"ramos", s:"ramo"}}, 
                            {p: "hojas", s: "hoja", g: "f", cont: {p:"montones", s:"montón"}},
                            {p: "mariposas", s: "mariposa", g: "f", cont: {p:"grupos", s:"grupo"}},
                            {p: "piedras", s: "piedra", g: "f", cont: {p:"colecciones", s:"colección"}},
                            {p: "pájaros", s: "pájaro", g: "m", cont: {p:"bandadas", s:"bandada"}},
                            {p: "árboles", s: "árbol", g: "m", cont: {p:"hileras", s:"hilera"}}
                        ],
                        templates: {
                            'SUMAS': [
                                "En una hermosa mañana soleada de primavera, Sofía paseaba alegremente por el parque del barrio cuando descubrió {n1} flores silvestres de colores brillantes caídas en el suelo. Más adelante, cerca de la fuente principal, encontró {n2} flores más. ¿Cuántas flores tiene Sofía en total?", 
                                "En el jardín principal del parque de la ciudad, el jardinero dedicado plantó con mucho cuidado {n1} flores en la sección norte junto a la fuente. Después de descansar, plantó {n2} flores más en la sección sur. ¿Cuántas flores hay en total?",
                                "Mateo observaba fascinado cómo caían las hojas en otoño. Primero contó {n1} hojas doradas y rojizas que cayeron junto a la banca donde estaba sentado. Poco después, con otra ráfaga de viento otoñal, cayeron {n2} hojas más formando un hermoso tapete natural. ¿Cuántas hojas cayeron en total?",
                                "La maestra organizó una salida educativa al parque botánico municipal. En el sector de rosas, Sofía contó {n1} flores completamente abiertas y perfumadas. En el sector de tulipanes que visitaron después, contó {n2} flores de colores vibrantes y alegres. ¿Cuántas flores vio en total durante el recorrido?"
                            ],
                            'RESTAS': [
                                "Mateo preparó con mucho amor un hermoso ramo con {n1} flores perfumadas para regalarle a su mamá en su cumpleaños. Mientras caminaba feliz por el sendero empedrado del parque, tropezó y {n2} flores se cayeron. ¿Cuántas flores le quedan?", 
                                "En un árbol grande del parque había {n1} hojas verdes y brillantes colgando de una rama alta. De repente sopló un viento fuerte y frío que desprendió {n2} hojas que cayeron al suelo. ¿Cuántas hojas siguen en la rama?",
                                "El jardinero del parque municipal sembró {n1} flores ornamentales muy hermosas en el jardín principal cerca de la entrada. Después de varios días de intenso calor y sequía, notó tristemente que {n2} flores se marchitaron por falta de agua. ¿Cuántas flores siguen frescas y saludables?",
                                "Sofía recolectó {n1} hojas de diferentes formas, tamaños y colores para su proyecto escolar de ciencias naturales sobre la biodiversidad. Durante el camino de regreso a su casa, el viento fuerte sopló y le arrebató {n2} hojas de su carpeta abierta. ¿Cuántas hojas le quedan para completar su proyecto?"
                            ],
                            'MULTIPLICACION': [
                                "Para el festival de primavera del colegio, Sofía preparó con mucho entusiasmo {n1} ramos de flores muy coloridas y hermosas. En cada ramo colocó con cuidado {n2} flores cuidadosamente seleccionadas por sus colores vivos y tamaños perfectos. ¿Cuántas flores utilizó en total?", 
                                "En el parque de la comunidad instalaron {n1} macetas grandes y decoradas con diseños alegres y llamativos. Los jardineros del municipio plantaron {n2} flores coloridas y aromáticas en cada maceta nueva del parque. ¿Cuántas flores hay en total en todas las macetas?",
                                "El club de jardinería del barrio organizó un taller de decoración floral muy interesante. Mateo ayudó a crear {n1} arreglos florales hermosos para el evento comunitario del fin de semana. Cada arreglo requería exactamente {n2} flores frescas y aromáticas recién cortadas. ¿Cuántas flores se necesitaron en total?",
                                "Para el proyecto de embellecimiento del parque central, se colocaron {n1} jardineras nuevas de madera tratada en diferentes senderos principales. Los voluntarios plantaron cuidadosamente {n2} flores multicolores en cada jardinera siguiendo un diseño paisajístico profesional. ¿Cuántas flores plantaron en total los voluntarios?"
                            ],
                            'DIVISIONES': [
                                { template: "Sofía y sus amigos del salón recolectaron {total} flores hermosas para celebrar el Día del Medio Ambiente en la escuela. Quieren crear {n1} ramos especiales con la misma cantidad de flores en cada uno para decorar las aulas. ¿Cuántas flores debe colocar en cada ramo?", answer: 'n2' },
                                { template: "El maestro de ciencias pidió a Mateo organizar cuidadosamente {total} hojas en diferentes montones para realizar un interesante experimento de botánica. Cada montón debe tener exactamente {n2} hojas para que el experimento funcione correctamente. ¿Cuántos montones completos podrá crear Mateo con todas las hojas?", answer: 'n1' },
                                { template: "El ayuntamiento donó {total} flores ornamentales de temporada al parque del vecindario para renovar los espacios verdes. El encargado debe distribuirlas equitativamente en {n1} zonas diferentes del parque según el plan de diseño paisajístico aprobado. ¿Cuántas flores corresponden a cada zona del parque?", answer: 'n2' },
                                { template: "Sofía recolectó {total} hojas de diversos árboles autóctonos para su colección botánica escolar. Necesita organizarlas en su álbum colocando exactamente {n2} hojas por página para mantener el orden y la presentación profesional. ¿Cuántas páginas completas llenará con todas las hojas recolectadas?", answer: 'n1' }
                            ]
                        }
                    },
                    {
                        tema: "FIESTA",
                        personajes: ["Leo", "Valentina", "Emma", "Santiago", "Martina", "Nicolás"],
                        sujetos: [
                            {p: "globos", s: "globo", g: "m", cont: {p:"grupos", s:"grupo"}}, 
                            {p: "caramelos", s: "caramelo", g: "m", cont: {p:"bolsas", s:"bolsa"}},
                            {p: "regalos", s: "regalo", g: "m", cont: {p:"pilas", s:"pila"}},
                            {p: "velas", s: "vela", g: "f", cont: {p:"paquetes", s:"paquete"}},
                            {p: "invitados", s: "invitado", g: "m", cont: {p:"mesas", s:"mesa"}},
                            {p: "serpentinas", s: "serpentina", g: "f", cont: {p:"rollos", s:"rollo"}}
                        ],
                        templates: {
                            'SUMAS': [
                                "Era el cumpleaños número ocho de Leo y estaba muy emocionado por su gran fiesta. Para decorar su casa con mucha alegría, Leo infló con energía {n1} globos de colores brillantes: rojos, azules y amarillos. Después de descansar y tomar refresco, infló {n2} globos más. ¿Cuántos globos infló en total?", 
                                "En la fiesta de fin de curso del colegio, Valentina estaba muy contenta porque recibió una bolsa sorpresa con {n1} caramelos deliciosos de diferentes sabores. Luego ganó un emocionante juego de sillas y recibió otra bolsa con {n2} caramelos más. ¿Cuántos caramelos tiene Valentina en total?",
                                "Para la celebración del día del niño en el barrio, Leo compró en la tienda local {n1} globos con forma de animales y personajes animados. Su tía llegó con una sorpresa adicional: {n2} globos más con brillantina y diseños metálicos. ¿Cuántos globos tienen ahora en total para la decoración?",
                                "En la piñata de la fiesta había {n1} caramelos de frutas tropicales: mango, piña y fresa. Cuando la rompieron cayeron {n2} caramelos más de chocolate y leche que estaban escondidos en el fondo. ¿Cuántos caramelos salieron en total de la piñata?"
                            ],
                            'RESTAS': [
                                "Leo cuidaba con mucha atención {n1} globos brillantes y coloridos que decoraban la fiesta de cumpleaños. Durante los juegos animados, algunos niños muy contentos saltaron cerca de la decoración y explotaron accidentalmente {n2} globos. ¿Cuántos globos le quedaron a Leo sin explotar después del accidente?", 
                                "Valentina llevó {n1} caramelos envueltos en papel de colores a la fiesta de su escuela para compartir con todos sus amigos. Con mucha alegría y generosidad repartió {n2} caramelos entre sus amigos del salón de clases. ¿Cuántos caramelos le quedan todavía a Valentina para ella?",
                                "El animador de la fiesta infantil preparó un espectáculo con {n1} globos de helio flotando en el techo decorado del salón. Algunos niños emocionados soltaron sin querer {n2} globos que escaparon volando por la ventana abierta hacia el cielo azul. ¿Cuántos globos quedaron flotando dentro del salón?",
                                "Leo guardó cuidadosamente {n1} caramelos especiales en su alcancía de dulces después de la fiesta de Halloween del vecindario. Durante la semana comió {n2} caramelos mientras hacía sus tareas escolares y veía sus programas favoritos. ¿Cuántos caramelos le quedan aún en su alcancía de dulces?"
                            ],
                            'MULTIPLICACION': [
                                "Para la fiesta sorpresa de su papá el fin de semana, Leo preparó con mucho cariño {n1} grupos especiales llenos de detalles bonitos y coloridos. En cada grupo colocó cuidadosamente {n2} globos de los colores favoritos de su papá. ¿Cuántos globos utilizó Leo en total para la sorpresa?",
                                "Para la fiesta de graduación de los estudiantes de sexto grado, el comité organizador formó {n1} grupos decorativos muy bonitos con globos brillantes. Cada grupo necesitó exactamente {n2} globos coloridos para verse perfecto. ¿Cuántos globos se necesitaron en total para toda la decoración?",
                                "El salón de fiestas contrató a un decorador profesional que diseñó {n1} arcos espectaculares con globos entrelazados para la entrada y las mesas principales. Cada arco requirió precisamente {n2} globos inflados al mismo tamaño para mantener simetría y balance visual. ¿Cuántos globos se usaron en total en todos los arcos?",
                                "Valentina organizó bolsitas de dulces para los invitados a su fiesta temática de princesas. Preparó con dedicación {n1} bolsitas decoradas con listones brillantes y stickers. En cada bolsita colocó exactamente {n2} caramelos variados de colores del arcoíris. ¿Cuántos caramelos utilizó en total para todas las bolsitas?"
                            ],
                            'DIVISIONES': [
                                { template: "Después de su cumpleaños tan divertido y emocionante, Leo tiene {total} caramelos que quiere compartir por igual con sus {n1} mejores amigos del colegio. Si reparte todos los caramelos de manera justa y equitativa, ¿cuántos caramelos le tocan a cada uno de sus amigos?", answer: 'n2' },
                                { template: "Valentina recibió de regalo {total} globos que necesita guardar organizadamente en varias bolsas para llevarlos a diferentes eventos escolares. Cada bolsa debe tener exactamente {n2} globos para transportarlos sin problemas. ¿Cuántas bolsas completas necesitará Valentina para guardar todos los globos correctamente?", answer: 'n1' },
                                { template: "La coordinadora de eventos del club social compró {total} caramelos gourmet importados para una fiesta elegante de aniversario. Necesita distribuirlos equitativamente en {n1} mesas decoradas con centros de flores frescas. ¿Cuántos caramelos debe colocar en cada mesa para que todas tengan la misma cantidad?", answer: 'n2' },
                                { template: "Leo tiene {total} globos de helio de colores variados sobrantes de varias fiestas que organizó durante el año. Quiere crear centros de mesa flotantes colocando {n2} globos en cada arreglo decorativo con cintas y pesos. ¿Cuántos centros de mesa completos podrá crear con todos los globos disponibles?", answer: 'n1' }
                            ]
                        }
                    },
                    {
                        tema: "TIENDA",
                        personajes: ["Laura", "Daniel", "Gabriela", "Andrés", "Carolina", "Felipe"],
                        sujetos: [
                            {p: "juguetes", s: "juguete", g: "m", cont: {p:"cajas", s:"caja"}}, 
                            {p: "libros", s: "libro", g: "m", cont: {p:"estantes", s:"estante"}},
                            {p: "peluches", s: "peluche", g: "m", cont: {p:"vitrinas", s:"vitrina"}},
                            {p: "videojuegos", s: "videojuego", g: "m", cont: {p:"paquetes", s:"paquete"}},
                            {p: "muñecas", s: "muñeca", g: "f", cont: {p:"exhibidores", s:"exhibidor"}},
                            {p: "rompecabezas", s: "rompecabezas", g: "m", cont: {p:"sets", s:"set"}}
                        ],
                        templates: {
                           'SUMAS': [
                               "En el estante principal de la gran juguetería del centro comercial, el encargado colocó cuidadosamente {n1} juguetes de última generación educativos y electrónicos. Más tarde llegó el camión de reparto y el gerente ordenó colocar {n2} juguetes adicionales. ¿Cuántos juguetes hay ahora en total en ese estante?", 
                               "Era el cumpleaños de Laura y sus padres la llevaron a la librería del barrio donde eligió {n1} libros de aventuras y ciencia que quería leer. Su mejor amigo llegó con un regalo: una bolsa con {n2} libros más de su colección favorita. ¿Cuántos libros tiene Laura en total para leer?",
                               "En la tienda de antigüedades del centro histórico, el dueño exhibía {n1} juguetes coleccionables vintage de los años ochenta y noventa. Un coleccionista vendió su colección personal y agregó {n2} juguetes más raros y valiosos a la vitrina principal. ¿Cuántos juguetes coleccionables hay ahora en exhibición?",
                               "Daniel visitó la feria del libro anual de la ciudad buscando libros de su saga favorita de fantasía épica. En el primer stand encontró {n1} libros que le faltaban de la colección. En otro stand descubrió {n2} libros adicionales con ediciones especiales ilustradas. ¿Cuántos libros compró en total en la feria?"
                           ],
                           'RESTAS': [
                               "En la bodega trasera de la tienda de juguetes educativos, una gran caja contenía {n1} juguetes recién importados: rompecabezas, sets de ciencia y robots. Durante la revisión de calidad, Daniel descubrió que {n2} juguetes tenían defectos de fabricación y tuvo que separarlos. ¿Cuántos juguetes en perfecto estado quedan?", 
                               "La tienda especializada en libros educativos tenía {n1} libros catalogados como mercancía disponible para la venta en su almacén principal. Después de una auditoría exhaustiva, Laura identificó que {n2} libros estaban deteriorados por humedad y manchas. ¿Cuántos libros quedaron en perfectas condiciones para vender?",
                               "Durante el inventario mensual de la juguetería, el gerente contabilizó {n1} juguetes electrónicos en el almacén de mercancía nueva. Al revisar las fechas de caducidad de las baterías incluidas, encontró que {n2} juguetes tenían baterías vencidas y debían retirarse. ¿Cuántos juguetes electrónicos están listos para venderse?",
                               "La librería universitaria recibió un pedido especial de {n1} libros de texto científicos para el nuevo semestre académico. Durante la distribución, Laura notó que {n2} libros tenían páginas mal impresas o encuadernaciones defectuosas y fueron devueltos. ¿Cuántos libros de texto quedaron en perfecto estado?"
                           ],
                           'MULTIPLICACION': [
                               "Era día de reposición en la megatienda de juguetes. Muy temprano llegó el camión con {n1} cajas grandes de cartón. Los trabajadores verificaron que cada caja contenía exactamente {n2} juguetes nuevos empaquetados individualmente listos para exhibirse. ¿Cuántos juguetes nuevos llegaron en total en ese envío matutino importante?", 
                               "Daniel trabaja organizando la biblioteca municipal. Su tarea era distribuir libros infantiles donados en {n1} estantes diferentes del área infantil, cada uno con una temática específica. En cada estante colocó con precisión exactamente {n2} libros bien alineados. ¿Cuántos libros organizó Daniel en total en todos los estantes?",
                               "Para la campaña navideña especial, la tienda de juguetes creó {n1} paquetes promocionales familiares con descuentos atractivos del treinta por ciento. Cada paquete incluía cuidadosamente {n2} juguetes diferentes seleccionados por expertos en desarrollo infantil. ¿Cuántos juguetes se necesitaron en total para armar todos los paquetes promocionales?",
                               "La editorial lanzó una colección especial de clásicos literarios mundiales. Laura coordinó el envío a {n1} librerías afiliadas en diferentes ciudades del país. Cada librería recibiría exactamente {n2} libros de esta edición limitada con portadas doradas. ¿Cuántos libros se distribuyeron en total a todas las librerías?"
                           ],
                           'DIVISIONES': [
                               { template: "La fábrica de juguetes está preparando un pedido nacional importante. Han fabricado {total} juguetes de alta calidad que deben empaquetarse en cajas especializadas de cartón reforzado. Cada caja debe contener exactamente {n2} juguetes según las especificaciones del cliente. ¿Cuántas cajas necesitará preparar la fábrica para empaquetar todos los juguetes?", answer: 'n1' },
                               { template: "El profesor asignó a Daniel organizar la biblioteca del aula con {total} libros de diferentes materias: matemáticas, ciencias, lenguaje e historia. Debe distribuirlos equitativamente en {n1} estantes nuevos de madera. ¿Cuántos libros debe colocar Daniel en cada estante para balancearlos correctamente?", answer: 'n2' },
                               { template: "El almacén central de la cadena de jugueterías recibió {total} juguetes electrónicos educativos que deben enviarse equitativamente a {n1} sucursales en el área metropolitana para mantener el mismo stock en todas. ¿Cuántos juguetes electrónicos recibirá cada sucursal del área metropolitana?", answer: 'n2' },
                               { template: "Para la campaña de donación de libros a comunidades rurales, se recolectaron {total} libros infantiles y juveniles nuevos y usados en buen estado. Estos se enviarán a escuelas rurales colocando {n2} libros en cada caja de transporte resistente. ¿Cuántas cajas se necesitarán para enviar todos los libros donados?", answer: 'n1' }
                           ]
                        }
                    },
                    {
                        tema: "ESCUELA",
                        personajes: ["Camila", "Diego", "Alejandra", "Tomás", "Daniela", "Emilio"],
                        sujetos: [
                            {p: "lápices", s: "lápiz", g: "m", cont: {p:"estuches", s:"estuche"}}, 
                            {p: "hojas", s: "hoja", g: "f", cont: {p:"paquetes", s:"paquete"}},
                            {p: "borradores", s: "borrador", g: "m", cont: {p:"cajas", s:"caja"}},
                            {p: "cuadernos", s: "cuaderno", g: "m", cont: {p:"pilas", s:"pila"}},
                            {p: "marcadores", s: "marcador", g: "m", cont: {p:"estuches", s:"estuche"}},
                            {p: "reglas", s: "regla", g: "f", cont: {p:"sets", s:"set"}}
                        ],
                        templates: {
                           'SUMAS': [
                               "Camila llegó temprano a la clase de arte y encontró {n1} lápices de colores brillantes olvidados sobre la mesa de trabajo. Más tarde, al revisar su mochila nueva, descubrió {n2} lápices más que había guardado del día anterior. ¿Cuántos lápices tiene Camila disponibles para su clase de arte?",
                               "En la clase de redacción, Diego tenía {n1} hojas en blanco en su cuaderno de trabajo para escribir su composición literaria. La maestra le entregó {n2} hojas adicionales con líneas guía para que pudiera hacer un borrador completo. ¿Cuántas hojas tiene Diego en total para su trabajo?",
                               "Durante el primer día de clases del año escolar, el director entregó a Camila {n1} lápices nuevos del programa de útiles escolares gratuitos. Su abuela, muy orgullosa, le regaló {n2} lápices más con diseños de sus personajes favoritos. ¿Cuántos lápices tiene Camila en total para empezar el año?",
                               "El profesor de matemáticas preparó una actividad especial y entregó {n1} hojas con ejercicios de geometría analítica a Diego. Al final de la clase, le dio {n2} hojas más con problemas adicionales para practicar en casa. ¿Cuántas hojas con ejercicios tiene Diego para resolver?"
                           ],
                           'RESTAS': [
                               "Diego organizó su estuche nuevo al inicio del bimestre y contó {n1} lápices de diferentes tipos: grafito, colores y bicolor. Durante la semana de exámenes finales utilizó tanto que {n2} lápices se gastaron completamente hasta quedar muy cortos. ¿Cuántos lápices útiles le quedan en su estuche?",
                               "Para el proyecto de investigación científica del semestre, Camila tenía {n1} hojas impresas con información importante de diversas fuentes confiables. Al organizar su carpeta descubrió que {n2} hojas estaban duplicadas innecesariamente y decidió reciclarlas. ¿Cuántas hojas únicas le quedaron para su proyecto?",
                               "En el salón de clases había {n1} lápices comunitarios en el bote de préstamo para los estudiantes que olvidaban sus útiles. Durante el día algunos estudiantes tomaron prestados {n2} lápices y no los devolvieron antes del recreo. ¿Cuántos lápices quedaron disponibles en el bote comunitario?",
                               "Diego imprimió {n1} hojas con mapas históricos detallados para su exposición de geografía mundial del próximo viernes. Al revisar la calidad de impresión notó que {n2} hojas salieron borrosas o con manchas de tinta. ¿Cuántas hojas con mapas nítidos tiene para su exposición?"
                           ],
                           'MULTIPLICACION': [
                               "La escuela organizó kits escolares para donar a estudiantes de bajos recursos de la comunidad. Camila ayudó a preparar {n1} estuches completos y nuevos. En cada estuche colocó cuidadosamente {n2} lápices de buena calidad: grafito, colores y marcadores. ¿Cuántos lápices se donaron en total a través de todos los estuches?",
                               "Para el taller de origami que se realizará en el festival cultural escolar, Diego organizó {n1} paquetes de papel especial de colores vibrantes. Cada paquete contenía exactamente {n2} hojas cuadradas perfectas de diferentes tonalidades. ¿Cuántas hojas de papel tiene disponibles en total para el taller?",
                               "El coordinador académico compró para el departamento de arte {n1} cajas grandes de lápices especiales para dibujo técnico y artístico. Verificó que cada caja sellada contuviera {n2} lápices de diferentes durezas: H, HB y B. ¿Cuántos lápices de dibujo tiene disponibles el departamento de arte?",
                               "Camila preparó material didáctico para su exposición final de ciencias naturales sobre ecosistemas. Organizó {n1} carpetas temáticas con información clasificada por bioma. En cada carpeta incluyó exactamente {n2} hojas informativas con gráficos, diagramas y fotografías. ¿Cuántas hojas informativas preparó en total?"
                           ],
                           'DIVISIONES': [
                               { template: "El maestro de plástica tiene {total} lápices de colores profesionales para distribuir equitativamente entre {n1} mesas de trabajo del aula de arte. Cada mesa debe recibir la misma cantidad para trabajar el proyecto semestral. ¿Cuántos lápices de colores recibirá cada mesa de trabajo?", answer: 'n2' },
                               { template: "Para el examen diagnóstico estandarizado, la coordinadora académica preparó {total} hojas con preguntas de opción múltiple impresas en formato oficial. Necesita organizar las hojas en grupos de {n2} hojas para cada cuadernillo de examen completo. ¿Cuántos cuadernillos completos podrá armar con todas las hojas disponibles?", answer: 'n1' },
                               { template: "Diego recolectó {total} lápices usados pero funcionales de todos los estudiantes de su grado para donarlos a escuelas rurales. Quiere empaquetarlos ordenadamente colocando {n2} lápices en cada bolsa transparente con cierre hermético. ¿Cuántas bolsas completas necesitará para empaquetar todos los lápices recolectados?", answer: 'n1' },
                               { template: "La fotocopiadora de la escuela tiene {total} hojas de papel reciclado de alta calidad para uso sostenible. El personal administrativo debe dividirlas equitativamente entre {n1} departamentos académicos del plantel. ¿Cuántas hojas le corresponden a cada departamento académico?", answer: 'n2' }
                           ]
                        }
                    },
                    {
                        tema: "GRANJA",
                        personajes: ["Rosa", "Miguel", "Patricia", "Ricardo", "Elena", "Fernando"],
                        sujetos: [
                            {p: "huevos", s: "huevo", g: "m", cont: {p:"canastas", s:"canasta"}}, 
                            {p: "zanahorias", s: "zanahoria", g: "f", cont: {p:"manojos", s:"manojo"}},
                            {p: "manzanas", s: "manzana", g: "f", cont: {p:"cestas", s:"cesta"}},
                            {p: "tomates", s: "tomate", g: "m", cont: {p:"cajones", s:"cajón"}},
                            {p: "pollos", s: "pollo", g: "m", cont: {p:"corrales", s:"corral"}},
                            {p: "lechugas", s: "lechuga", g: "f", cont: {p:"hileras", s:"hilera"}}
                        ],
                        templates: {
                           'SUMAS': [
                               "Rosa despertó muy temprano en la mañana para recoger huevos frescos del gallinero principal de la granja familiar. En el primer nido encontró {n1} huevos tibios y limpios recién puestos. En el segundo nido descubrió {n2} huevos más de buen tamaño. ¿Cuántos huevos recolectó Rosa en total esa mañana?",
                               "Miguel trabajaba en la huerta orgánica cosechando vegetales maduros para el mercado del pueblo. Primero arrancó {n1} zanahorias grandes y naranjas de perfecta forma. Después cosechó {n2} zanahorias más de un surco diferente que estaban listas. ¿Cuántas zanahorias cosechó Miguel en total?",
                               "En el corral de las gallinas ponedoras había varios nidos bien organizados con paja fresca. Rosa revisó la sección norte y encontró {n1} huevos moteados de color café. En la sección sur del corral encontró {n2} huevos más de color blanco puro. ¿Cuántos huevos había en total en ambas secciones?",
                               "El abuelo de Miguel le enseñó a cosechar zanahorias correctamente sin dañar las raíces. En el primer surco del huerto familiar sacó cuidadosamente {n1} zanahorias dulces y crujientes. En el segundo surco cosechó {n2} zanahorias más de tamaño similar. ¿Cuántas zanahorias cosechó en total bajo la supervisión de su abuelo?"
                           ],
                           'RESTAS': [
                               "Miguel recolectó en su canasta de mimbre {n1} huevos frescos y limpios de las gallinas de la granja ecológica. Mientras caminaba cuidadosamente hacia la cocina de la casa, tropezó con una piedra y {n2} huevos se cayeron y se rompieron. ¿Cuántos huevos intactos le quedaron en la canasta?",
                               "Rosa cosechó del huerto orgánico familiar {n1} zanahorias hermosas de color naranja intenso y hojas verdes frescas. Al lavarlas en el lavadero exterior, notó que {n2} zanahorias estaban picadas por insectos del suelo y tuvo que desecharlas. ¿Cuántas zanahorias sanas quedaron para cocinar?",
                               "El gallinero automatizado de la granja moderna tenía {n1} huevos almacenados en la bandeja recolectora del sistema de refrigeración. Durante la inspección de calidad matutina, Miguel descartó {n2} huevos que presentaban grietas microscópicas en el cascarón. ¿Cuántos huevos de primera calidad quedaron para vender?",
                               "En el invernadero hidropónico, Rosa separó {n1} zanahorias baby perfectamente formadas y listas para el mercado gourmet de la ciudad. Al clasificarlas por tamaño para el empaque, apartó {n2} zanahorias que eran demasiado pequeñas según los estándares comerciales. ¿Cuántas zanahorias cumplieron con el tamaño comercial requerido?"
                           ],
                           'MULTIPLICACION': [
                               "Para vender en el mercado dominical del pueblo, Rosa preparó {n1} canastas artesanales tejidas a mano con paja natural. En cada canasta decorada colocó cuidadosamente {n2} huevos frescos envueltos en papel periódico limpio. ¿Cuántos huevos llevó Rosa en total al mercado ese domingo?",
                               "Miguel organizó la producción semanal del huerto orgánico certificado en manojos comerciales. Preparó {n1} manojos atados con rafia natural biodegradable. Cada manojo contenía exactamente {n2} zanahorias frescas de tamaño uniforme y hojas verdes. ¿Cuántas zanahorias organizó en total en todos los manojos?",
                               "La cooperativa agrícola local encargó a Rosa proveer huevos para el programa de alimentación escolar. Preparó {n1} cajas de cartón reciclado especiales. Cada caja llevaba protegidos con separadores {n2} huevos de gallinas criadas al aire libre. ¿Cuántos huevos entregó en total para el programa escolar?",
                               "Para la feria agroecológica regional, Miguel seleccionó zanahorias premium de cosecha reciente. Armó {n1} paquetes promocionales con etiquetas artesanales. Cada paquete exhibía {n2} zanahorias orgánicas certificadas de color naranja brillante. ¿Cuántas zanahorias incluyó en total en todos los paquetes para la feria?"
                           ],
                           'DIVISIONES': [
                               { template: "La granja avícola produjo {total} huevos frescos durante la semana de máxima producción estacional. Rosa necesita distribuirlos equitativamente en {n1} bandejas especiales de cartón para la venta local. ¿Cuántos huevos debe colocar en cada bandeja para distribuir toda la producción?", answer: 'n2' },
                               { template: "Miguel cosechó {total} zanahorias orgánicas maduras de excelente calidad del campo cultivado. Debe empaquetarlas en manojos decorativos colocando exactamente {n2} zanahorias por manojo con hojas frescas. ¿Cuántos manojos completos podrá preparar con toda la cosecha del día?", answer: 'n1' },
                               { template: "El programa de agricultura sustentable donará {total} huevos nutritivos a familias de la comunidad rural cercana. Los organizadores quieren repartirlos equitativamente entre {n1} familias beneficiarias del programa social. ¿Cuántos huevos recibirá cada familia beneficiaria del programa?", answer: 'n2' },
                               { template: "Rosa recolectó {total} zanahorias baby premium para restaurantes gourmet de la capital. Necesita empaquetar las zanahorias en bolsas al vacío de presentación colocando {n2} zanahorias en cada bolsa sellada. ¿Cuántas bolsas al vacío completas podrá preparar con todas las zanahorias cosechadas?", answer: 'n1' }
                           ]
                        }
                    }
                ],
                getRandomElement: function(arr) { return arr[Math.floor(PRNG.next() * arr.length)]; },
                getRandomNumber: function(min, max) { return Math.floor(PRNG.next() * (max - min + 1)) + min; },
                populateTemplate: function(template, context) { var populated = template; for (var key in context) { var regex = new RegExp('{' + key + '}', 'g'); populated = populated.replace(regex, context[key]); } return populated; },
                generateOptions: function(correctAnswer) {
                    var options = [correctAnswer];
                    while (options.length < 4) { var offset = this.getRandomNumber(1, 10) * (PRNG.next() > 0.5 ? 1 : -1); var distractor = correctAnswer + offset; if (options.indexOf(distractor) === -1 && distractor >= 0 && distractor !== correctAnswer) { options.push(distractor); } }
                    for (var i = options.length - 1; i > 0; i--) { var j = Math.floor(PRNG.next() * (i + 1)); var temp = options[i]; options[i] = options[j]; options[j] = temp; }
                    return options;
                },
                createQuestion: function(type) {
                    var profile = state.activeProfile ? state.profiles[state.activeProfile] : null;
                    var solvedInCategory = profile ? (profile.solvedQuestions[type] ? profile.solvedQuestions[type].length : 0) : 0;
                    var masteryRankIndex = Math.floor(solvedInCategory / 5);
                    var difficultyConfig = ESCALADO_DE_DIFICULTAD[type][Math.min(masteryRankIndex, ESCALADO_DE_DIFICULTAD[type].length - 1)];
                    
                    var pack = this.getRandomElement(this.thematicPacks);
                    var sujeto = this.getRandomElement(pack.sujetos);
                    var personaje = this.getRandomElement(pack.personajes);
                    var n1, n2, correctAnswer, total, template, templateObj;
                    var context = {};
                    
                    var templateArray = pack.templates[type];

                    if (type === 'SUMAS') {
                        n1 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max); n2 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max);
                        correctAnswer = n1 + n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'RESTAS') {
                        n1 = this.getRandomNumber(difficultyConfig.n1_min, difficultyConfig.n1_max); n2 = this.getRandomNumber(difficultyConfig.n2_min, Math.min(n1 - 1, difficultyConfig.n2_max));
                        correctAnswer = n1 - n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'MULTIPLICACION') {
                        n1 = this.getRandomNumber(2, 5); n2 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max);
                        if (PRNG.next() > 0.5) { var temp = n1; n1 = n2; n2 = temp; }
                        correctAnswer = n1 * n2;
                        template = this.getRandomElement(templateArray);
                    } else if (type === 'DIVISIONES') {
                        n1 = this.getRandomNumber(difficultyConfig.min, difficultyConfig.max); n2 = this.getRandomNumber(2, 5);
                        if (n1 === 0 || n2 === 0) { n2 = 2; }
                        total = n1 * n2;
                        context.total = (PRNG.next() > 0.5) ? numberToLiteral(total, sujeto.g) : total;
                        templateObj = this.getRandomElement(templateArray);
                        template = templateObj.template;
                        correctAnswer = (templateObj.answer === 'n1') ? n1 : n2;
                    }

                    context.personaje = personaje; 
                    context.n1 = (PRNG.next() > 0.5) ? numberToLiteral(n1, sujeto.g) : n1;
                    context.n2 = (PRNG.next() > 0.5) ? numberToLiteral(n2, sujeto.g) : n2;
                    context.sujeto_p = sujeto.p; context.sujeto_s = sujeto.s;
                    context.cont_p = sujeto.cont.p; context.cont_s = sujeto.cont.s;
                    
                    var questionText = this.populateTemplate(template, context);
                    var options = this.generateOptions(correctAnswer);

                    return { id: type + ':' + new Date().getTime(), question: questionText, options: options, correctAnswerIndex: options.indexOf(correctAnswer) };
                }
            };
            
            var QuizManager = {
                startQuiz: function(d) {
                    function fnv1a(str) { for(var i = 0, h = 0x811c9dc5; i < str.length; i++) h = Math.imul(h ^ str.charCodeAt(i), 0x01000193); return h; }
                    var seed = fnv1a(state.activeProfile + d + state.profiles[state.activeProfile].solvedQuestions[d].length + new Date().getTime());
                    PRNG.seed(seed);

                    var profile = state.profiles[state.activeProfile];
                    var solvedInCategory = profile.solvedQuestions[d] ? profile.solvedQuestions[d].length : 0;
                    var masteryRankIndex = Math.floor(solvedInCategory / 5);
                    // CORREGIDO: Aumentado de 1.5 a 4 segundos por nivel para dar más tiempo en niveles avanzados
                    // Esto da 40s base + 4s por cada 5 preguntas resueltas (nivel 6-10: 44-48s, suficiente para leer)
                    var calculatedTime = Math.floor(BASE_QUESTION_TIME + (masteryRankIndex * 4));
                    state.quiz.totalTime = calculatedTime;

                    ui.gameHudPlayerName.textContent = 'JUGADOR :: ' + state.activeProfile;
                    var questionData = QuestionGenerator.createQuestion(d);
                    state.quiz.currentQuestion = questionData;
                    state.quiz.currentDifficulty = d;
                    state.quiz.isAnswered = false;
                    this.updateHud();
                    this.renderQuizUI();
                    EventBus.emit('system:requestNavigation', { windowId: 'game' });
                },
                handleAnswer: function(selectedIndex) {
                    if (state.quiz.isAnswered) return;
                    clearInterval(state.quiz.timerId);
                    state.quiz.isAnswered = true;
                    var isCorrect = selectedIndex === state.quiz.currentQuestion.correctAnswerIndex;
                    var optionButtons = ui.quizOptions.querySelectorAll('.option-button');
                    
                    if (selectedIndex >= 0) { 
                        optionButtons[selectedIndex].classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer');
                    }
                    
                    if (isCorrect) { 
                        AudioManager.playSound('success'); 
                        state.quiz.streak++;
                        var buttonRect = optionButtons[selectedIndex].getBoundingClientRect();
                        var centerX = buttonRect.left + buttonRect.width / 2;
                        var centerY = buttonRect.top + buttonRect.height / 2;
                        createCelebrationParticles(centerX, centerY);
                    } else { 
                        AudioManager.playSound('error'); 
                        state.quiz.streak = 0; 
                        if (selectedIndex !== -1 && optionButtons[state.quiz.currentQuestion.correctAnswerIndex]) {
                            optionButtons[state.quiz.currentQuestion.correctAnswerIndex].classList.add('correct-answer');
                        } 
                        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) { 
                            ui.glitchWrapper.classList.add('glitch-active'); 
                            ui.holographicPanel.classList.add('error-flash'); 
                            setTimeout(function() { 
                                ui.glitchWrapper.classList.remove('glitch-active'); 
                                ui.holographicPanel.classList.remove('error-flash'); 
                            }, 300); 
                        } 
                    }
                    this.updateHud();
                    optionButtons.forEach(function(btn) { btn.disabled = true; });
                    this.endQuiz(isCorrect, selectedIndex === -1);
                },
                endQuiz: function(wasCorrect, wasTimeout) {
                    var profile = state.profiles[state.activeProfile];
                    var difficulty = state.quiz.currentDifficulty;
                    if (wasCorrect) {
                        profile.aciertos++;
                        if (profile.solvedQuestions[difficulty].indexOf(state.quiz.currentQuestion.id) === -1) { 
                            profile.solvedQuestions[difficulty].push(state.quiz.currentQuestion.id); 
                        }
                    } else { 
                        profile.errores++;
                        profile.perfectRuns[difficulty] = false; 
                    }
                    saveProfilesToStorage();
                    setTimeout(function() {
                        if (wasCorrect) { 
                            EventBus.emit('quiz:victory'); 
                        } else if (wasTimeout) {
                            EventBus.emit('quiz:timeout');
                        } else {
                            var correctAnswerText = state.quiz.currentQuestion.options[state.quiz.currentQuestion.correctAnswerIndex]; 
                            EventBus.emit('quiz:defeat', { correctAnswer: 'LA RESPUESTA CORRECTA ERA: ' + correctAnswerText }); 
                        }
                    }, 1500);
                },
                updateHud: function() {
                    ui.gameHudStreak.textContent = "RACHA: " + state.quiz.streak;
                    
                    // Actualizar contador digital con formato MM:SS
                    var minutes = Math.floor(state.quiz.timerValue / 60);
                    var seconds = state.quiz.timerValue % 60;
                    var timeText = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    ui.digitalTimer.textContent = timeText;
                    
                    // Aplicar estilos según el tiempo restante
                    var timePercentage = (state.quiz.timerValue / state.quiz.totalTime) * 100;
                    ui.digitalTimer.classList.remove('warning', 'critical');
                    if (timePercentage < 25) { ui.digitalTimer.classList.add('critical'); } 
                    else if (timePercentage < 50) { ui.digitalTimer.classList.add('warning'); }
                },
                startTimer: function() {
                    state.quiz.timerValue = state.quiz.totalTime;
                    state.quiz.startTime = Date.now(); // Guardar el tiempo inicial
                    state.quiz.endTime = state.quiz.startTime + (state.quiz.totalTime * 1000); // Calcular tiempo final
                    this.updateHud();
                    
                    // Usar un intervalo más corto (100ms) para mayor precisión
                    state.quiz.timerId = setInterval(function() {
                        var now = Date.now();
                        var timeRemaining = Math.ceil((state.quiz.endTime - now) / 1000);
                        
                        // Solo actualizar si el valor cambió para evitar parpadeos
                        if (timeRemaining !== state.quiz.timerValue) {
                            state.quiz.timerValue = Math.max(0, timeRemaining);
                            QuizManager.updateHud();
                        }
                        
                        // Verificar timeout
                        if (now >= state.quiz.endTime) {
                            clearInterval(state.quiz.timerId);
                            state.quiz.timerValue = 0;
                            QuizManager.updateHud();
                            QuizManager.handleAnswer(-1); // -1 signifies a timeout
                        }
                    }, 100); // Actualizar cada 100ms para mayor precisión
                },
                renderQuizUI: function() {
                    ui.quizQuestion.textContent = state.quiz.currentQuestion.question;
                    ui.quizOptions.innerHTML = '';
                    state.quiz.currentQuestion.options.forEach(function(option, index) {
                        var button = document.createElement('button');
                        button.className = 'interactive-button option-button';
                        button.textContent = option;
                        button.setAttribute('data-option-index', index);
                        ui.quizOptions.appendChild(button);
                    });
                    this.startTimer();
                }
            };
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[BOOT][INFO] INICIALIZANDO QUIZ v8.0.2 (EXPANDED 6 CHARS 6 OBJECTS)...');
                loadSettings(); loadProfilesFromStorage(); applyPalette(state.settings.paletteIndex); updateSoundToggleButtons(); 
                calculateLayout();
                renderPlayerKeyboard(); 
                renderPaletteModalOptions();
                
                function advanceToProfiles() { AudioManager.init(); EventBus.emit('system:requestNavigation', { windowId: 'profiles', requestFullscreen: true }); }
                windows.title.addEventListener('click', advanceToProfiles); document.addEventListener('keydown', advanceToProfiles, { once: true });
                
                ui.reEnterFullscreenButton.addEventListener('click', function() { EventBus.emit('system:requestFullscreen'); });
                ui.goToPlayerCreateButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'player' }); });
                ui.cancelPlayerButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'profiles' }); });
                ui.backToProfilesButton.addEventListener('click', function() { EventBus.emit('profile:clearActive'); });
                ui.victoryToMenuButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'mainMenu', fromVictory: true }); });
                ui.gameOverToMenuButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'mainMenu' }); });
                ui.timeOutToMenuButton.addEventListener('click', function() { EventBus.emit('system:requestNavigation', { windowId: 'mainMenu' }); });
                ui.profilesList.addEventListener('click', function(e) { var n = e.target.getAttribute('data-profile-name'); if (!n) return; if (e.target.classList.contains('profile-button')) { EventBus.emit('profile:selected', { profileName: n }); } else if (e.target.classList.contains('delete-button')) { EventBus.emit('profile:deleted', { profileName: n }); } });
                ui.virtualKeyboard.addEventListener('click', function(e) { var k = e.target.getAttribute('data-key'); if (!k || !e.target.classList.contains('key')) return; EventBus.emit('player:input', { key: k }); });
                ui.levelGrid.addEventListener('click', function(e) { var b = e.target.closest('button[data-difficulty]'); if (b) { EventBus.emit('quiz:start', { difficulty: b.getAttribute('data-difficulty') }); } });
                ui.quizOptions.addEventListener('click', function(e) { var btn = e.target.closest('.option-button'); if (btn && !state.quiz.isAnswered) { AudioManager.playSound('tick'); EventBus.emit('quiz:answer', { selectedIndex: parseInt(btn.getAttribute('data-option-index'), 10) }); } });
                
                document.querySelectorAll('.settings-button').forEach(function(b) { b.addEventListener('click', function(e) { e.stopPropagation(); EventBus.emit('settings:show'); }); });
                document.querySelectorAll('.sound-toggle-button').forEach(function(b) { b.addEventListener('click', function() { state.settings.soundEnabled = !state.settings.soundEnabled; updateSoundToggleButtons(); saveSettings(); }); });
                ui.modalPaletteOptions.addEventListener('click', function(e) { if(e.target.hasAttribute('data-palette-index')) { state.settings.paletteIndex = parseInt(e.target.getAttribute('data-palette-index'), 10); applyPalette(state.settings.paletteIndex); saveSettings(); } });
                document.querySelectorAll('.close-session-button').forEach(function(b) { b.addEventListener('click', function() { EventBus.emit('settings:hide'); EventBus.emit('system:closeSession'); }); });
                document.querySelectorAll('.insignias-button').forEach(function(b) { b.addEventListener('click', function() { EventBus.emit('settings:hide'); EventBus.emit('insignias:show'); }); });
                ui.closeInsigniasButton.addEventListener('click', function() { EventBus.emit('insignias:hide'); });
                ui.closeSettingsModalButton.addEventListener('click', function() { EventBus.emit('settings:hide'); });
                
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) { document.body.addEventListener('mousemove', function(e) { var x = (e.clientX / window.innerWidth) - 0.5, y = (e.clientY / window.innerHeight) - 0.5, rx = y * -5, ry = x * 5; if(ui.holographicPanel) ui.holographicPanel.style.transform = 'rotateX(' + (10 + rx) + 'deg) rotateY(' + ry + 'deg)'; }); }
                
                window.addEventListener('resize', calculateLayout);
                document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); document.addEventListener('mozfullscreenchange', handleFullscreenChange); document.addEventListener('MSFullscreenChange', handleFullscreenChange);
                
                EventBus.on('system:requestNavigation', function(d) { AudioManager.playSound('navigate'); if(d.requestFullscreen) requestFullscreen(); if(d.fromVictory || d.windowId === 'mainMenu') { renderProfileRank(); populateLevelGrid(); renderProfileStats(); } if(d.windowId === 'profiles') { renderProfiles(); } showWindow(d.windowId); });
                EventBus.on('system:requestFullscreen', function() { AudioManager.playSound('navigate'); requestFullscreen(); });
                EventBus.on('system:closeSession', function() { AudioManager.playSound('navigate'); if (state.currentWindow === 'game') { clearInterval(state.quiz.timerId); } state.activeProfile = null; showWindow('profiles'); });
                
                EventBus.on('profile:selected', function(d) { 
                    AudioManager.playSound('navigate');
                    state.activeProfile = d.profileName;
                    state.quiz.streak = 0;
                    
                    var authTextEl = document.getElementById('auth-text');
                    showWindow('auth');
                    var messages = [
                        'AUTENTICANDO: ' + d.profileName,
                        'ACCESO CONCEDIDO',
                        'CARGANDO DATOS DE LA FLOTA ESTELAR...'
                    ];
                    var i = 0;
                    authTextEl.innerHTML = messages[i++] + '<span class="cursor"></span>';
                    var authInterval = setInterval(function() {
                        if (i < messages.length) {
                            authTextEl.innerHTML = messages[i++] + '<span class="cursor"></span>';
                        } else {
                            clearInterval(authInterval);
                            EventBus.emit('system:requestNavigation', { windowId: 'mainMenu' });
                        }
                    }, 800);
                });

                EventBus.on('profile:deleted', function(d) { AudioManager.playSound('error'); delete state.profiles[d.profileName]; saveProfilesToStorage(); renderProfiles(); });
                EventBus.on('profile:clearActive', function() { AudioManager.playSound('navigate'); state.activeProfile = null; showWindow('profiles'); });
                
                EventBus.on('player:input', function(d) {
                    AudioManager.playSound('tick');
                    var nameDisplay = ui.playerNameDisplay;
                    nameDisplay.classList.remove('shake', 'error-flash');
                    
                    // MEJORA 4: Feedback visual en las teclas
                    var keyElement = document.querySelector('[data-key="' + d.key + '"]');
                    if (keyElement) {
                        keyElement.classList.add('pressed');
                        setTimeout(function() {
                            keyElement.classList.remove('pressed');
                        }, 200);
                    }

                    if (d.key === 'Backspace') {
                        state.newPlayerName = state.newPlayerName.slice(0, -1);
                    } else if (d.key === 'Enter') {
                        var n = state.newPlayerName.trim();
                        if (n && !state.profiles[n]) {
                            state.profiles[n] = getEmptyProfileData();
                            saveProfilesToStorage();
                            renderProfiles();
                            showWindow('profiles');
                            state.newPlayerName = '';
                        } else {
                            void nameDisplay.offsetWidth;
                            nameDisplay.classList.add('error-flash');
                        }
                    } else if (d.key === 'Shift') {
                        state.isShiftActive = !state.isShiftActive;
                        renderPlayerKeyboard();
                    } else {
                        if (state.newPlayerName.length < 12 && d.key.length === 1) {
                            var char = d.key;
                            state.newPlayerName += state.isShiftActive ? char.toUpperCase() : char.toLowerCase();
                        } else if (state.newPlayerName.length >= 12) {
                            void nameDisplay.offsetWidth;
                            nameDisplay.classList.add('shake');
                        }
                    }
                    ui.playerNameText.textContent = state.newPlayerName;
                    nameDisplay.style.setProperty('--chars', state.newPlayerName.length);
                    
                    // MEJORA: Actualizar contador de caracteres
                    var charCountEl = document.getElementById('charCount');
                    if (charCountEl) {
                        charCountEl.textContent = state.newPlayerName.length;
                        var charCounterEl = document.getElementById('charCounter');
                        if (charCounterEl) {
                            if (state.newPlayerName.length >= 12) {
                                charCounterEl.style.color = 'var(--color-error)';
                            } else if (state.newPlayerName.length >= 10) {
                                charCounterEl.style.color = 'var(--color-warning)';
                            } else {
                                charCounterEl.style.color = 'var(--color-text-passive)';
                            }
                        }
                    }
                });

                EventBus.on('quiz:start', function(d) { QuizManager.startQuiz(d.difficulty); });
                EventBus.on('quiz:answer', function(d) { QuizManager.handleAnswer(d.selectedIndex); });
                EventBus.on('quiz:victory', function() { 
                    if (state.activeProfile) {
                        var profile = state.profiles[state.activeProfile];
                        var totalSolved = 0;
                        var categories = Object.keys(profile.solvedQuestions);
                        for (var i = 0; i < categories.length; i++) {
                            totalSolved += profile.solvedQuestions[categories[i]].length;
                        }
                        var rankIndex = Math.floor(totalSolved / 5);
                        rankIndex = Math.min(rankIndex, RANK_SHAPES.length - 1);
                        var insigniaShape = RANK_SHAPES[rankIndex];
                        
                        var display3d = document.getElementById('insignia3dDisplay');
                        if (display3d && insigniaShape) {
                            display3d.innerHTML = createInsigniaSVG(insigniaShape, '#FFD700');
                        }
                    }
                    showWindow('victory'); 
                });
                EventBus.on('quiz:defeat', function(d) { ui.gameOverCorrectAnswer.textContent = d.correctAnswer; showWindow('gameOver'); });
                EventBus.on('quiz:timeout', function() { showWindow('timeOut'); });
                EventBus.on('insignias:show', function() { renderInsignias(); showWindow('insignias'); });
                EventBus.on('insignias:hide', function() { showWindow(state.previousWindow); });
                EventBus.on('settings:show', function() { showWindow('settingsModal'); });
                EventBus.on('settings:hide', function() { showWindow(state.previousWindow); });
                
                var hoveredLevelCategory = null;
                ui.levelGrid.addEventListener('mouseover', function(e) {
                    var button = e.target.closest('button[data-difficulty]');
                    if (button) { 
                        hoveredLevelCategory = button.getAttribute('data-difficulty');
                        var profile = state.profiles[state.activeProfile];
                        var solved = profile.solvedQuestions[hoveredLevelCategory].length;
                        var rankIndex = Math.floor(solved / 5);
                        var timeBonus = rankIndex * 1.5;
                        
                        document.getElementById('infoValueTitle').textContent = MASTERY_NAMES[hoveredLevelCategory];
                        document.getElementById('infoValueSolved').textContent = solved;
                        document.getElementById('infoValueRank').textContent = RANK_NAMES[rankIndex] || 'Sin Rango';
                        document.getElementById('infoValueTime').textContent = "+" + timeBonus.toFixed(1) + "s (Total: " + (BASE_QUESTION_TIME + timeBonus).toFixed(1) + "s)";
                        
                        ui.categoryInfoPanel.classList.add('active');
                    }
                });
                ui.levelGrid.addEventListener('mouseout', function(e) { 
                    hoveredLevelCategory = null; 
                    ui.categoryInfoPanel.classList.remove('active');
                });

                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
                        if (state.currentWindow === 'mainMenu' && hoveredLevelCategory && state.activeProfile) {
                            console.log('[EGG] Combinación secreta activada para: ' + hoveredLevelCategory);
                            var profile = state.profiles[state.activeProfile];
                            if (profile) {
                                for (var i = 0; i < 5; i++) {
                                    profile.solvedQuestions[hoveredLevelCategory].push('EGG_' + Date.now() + i);
                                }
                                profile.aciertos += 5;
                                saveProfilesToStorage();
                                populateLevelGrid();
                                renderProfileRank();
                                renderProfileStats();
                                AudioManager.playSound('success');
                            }
                        }
                    }
                    
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'h') {
                        if (state.currentWindow === 'game' && !state.quiz.isAnswered) {
                            e.preventDefault();
                            var correctIndex = state.quiz.currentQuestion.correctAnswerIndex;
                            var correctButton = ui.quizOptions.querySelector('.option-button[data-option-index="' + correctIndex + '"]');
                            if (correctButton) {
                                AudioManager.playSound('navigate');
                                correctButton.classList.add('flash-hint');
                                setTimeout(function() {
                                    correctButton.classList.remove('flash-hint');
                                }, 700);
                            }
                        }
                    }
                });
                
                setTimeout(function() { showWindow('title'); }, 1000);
                console.log('[BOOT][INFO] PREFLIGHT OK. SISTEMA TOTALMENTE COMPATIBLE CON MANIFIESTO.');
            });
        })();
    </script>
</body>
</html>
